<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Statistics Unit 1: Exploring One-Variable Data</title>

    <!-- AP Statistics Data -->
    <script src="js/allUnitsData.js"></script>    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #f0f9ff;
            border-bottom: 2px solid #3b82f6;
            font-weight: bold;
        }
        
        /* Style for when the daily quota is met */
        body.quota-met-today::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(220, 255, 220, 1); /* Light green tint, increased opacity */
          z-index: -1; /* Place it behind most content */
          pointer-events: none; /* Allow clicks to pass through */
          transition: background-color 0.5s ease; /* Smooth transition */
        }
        
        /* Dark mode styles */
        @media (prefers-color-scheme: dark) {
            /* No dark mode for printable worksheets */
        }
        
        /* ****** Phase 4: Add Styles for Bookmark Button ****** */
        .bookmark-toggle-btn.bookmarked-active svg {
            color: #f59e0b; /* amber-500 */
        }
        .bookmark-toggle-btn:hover svg {
             color: #3b82f6; /* blue-500 */
         }
        .bookmark-toggle-btn.bookmarked-active:hover svg {
             color: #dc2626; /* red-600 for removing */
         }
        /* Prevent text selection on double click for buttons */
        .bookmark-toggle-btn, #global-bookmark-indicator button, #global-bookmark-indicator a {
             user-select: none;
             -webkit-user-select: none; /* Safari */
             -moz-user-select: none; /* Firefox */
             -ms-user-select: none; /* IE10+ */
         }
        .unit-tab.active-unit-tab {
            background-color: #e0f2fe; /* Light blue background */
            border-color: #3b82f6;     /* Blue border */
            color: #1e40af;            /* Dark blue text */
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">

    <!-- START Bookmark Indicator Placeholder -->
    <div id="global-bookmark-indicator" class="fixed top-2 right-2 z-50 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl print:hidden" style="display: none;">
        <!-- Content injected by displayGlobalBookmarkIndicator() JavaScript function -->
    </div>
    <!-- END Bookmark Indicator Placeholder -->

        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">AP Statistics Unit 1: Exploring One-Variable Data</h1>
            <p class="text-gray-600 mt-2">Tools and guides to help you succeed in AP Statistics</p>
            <div class="mt-2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-md inline-block">
                <span class="font-semibold">Exam Weight:</span>Unit 1 represents 15-23% of the AP Statistics Exam
            </div>
        </header>
        <!-- Unit Tab Navigation -->    
    <div id="unit-navigation" class="flex flex-wrap mb-4 border-b border-gray-300 pb-2">
        <span class="mr-4 font-semibold">Select Unit:</span>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="1">Unit 1</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="2">Unit 2</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="3">Unit 3</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="4">Unit 4</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="5">Unit 5</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="6">Unit 6</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="7">Unit 7</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="8">Unit 8</button>
        <button class="unit-tab px-3 py-1 mr-2 mb-2 border rounded" data-unit-id="9">Unit 9</button>
    </div>
        <!-- Tab Navigation -->
        <div class="flex mb-0 border-b border-gray-200">
            <div id="tab-learning-flow" class="tab-button active">Learning Flow</div>
            <div id="tab-flowchart" class="tab-button">Flowchart</div>
            <div id="tab-grok-prompt" class="tab-button">Grok Prompt</div>
            <div id="tab-study-materials" class="tab-button">Study Materials</div>
            <div id="tab-overall-progress" class="tab-button">Overall Progress</div>
        </div>
        <div class="mb-4">
            <div class="flex items-center mb-2">
              <label for="topic-select" class="mr-2 font-medium text-purple-800">Track your progress:</label>
              <select id="topic-select" class="p-2 border rounded-md">
                <option value="">Select a topic...</option>
              </select>
            </div>
            <div id="progress-text" class="text-center text-sm text-gray-700 mb-2"></div>
            <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
              <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        <!-- Tab Content -->
        <div class="bg-white rounded-b-lg shadow-md p-6">
            <!-- Learning Flow Tab -->
            <div id="content-learning-flow" class="tab-content active">
                <div id="learning-flow-app"></div>
            </div>
            
            <!-- Flowchart Tab -->
            <div id="content-flowchart" class="tab-content">
                <h2 class="text-xl font-bold mb-4">AP Statistics Learning Session Flowchart</h2>
                <p class="mb-4 text-gray-600">This flowchart shows the recommended learning process using your AP Statistics resources.</p>
                <div class="bg-gray-50 p-4 rounded-lg overflow-auto max-h-[80vh]">
                    <div class="mermaid" id="flowchart"></div>
                </div>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                    <div class="p-2 rounded bg-blue-100 text-blue-800">Blue: Setup</div>
                    <div class="p-2 rounded bg-yellow-100 text-yellow-800">Yellow: Video Learning</div>
                    <div class="p-2 rounded bg-green-100 text-green-800">Green: Practice</div>
                    <div class="p-2 rounded bg-purple-100 text-purple-800">Purple: Progress</div>
                    <div class="p-2 rounded bg-red-100 text-red-800">Red: Capstone</div>
                </div>
            </div>
            
            <!-- Grok Prompt Tab -->
            <div id="content-grok-prompt" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-4 text-center text-indigo-900">Start Your Grok Session</h2>
                <div class="text-xs text-gray-600 mb-4">
                    <span class="bg-green-100 text-green-800 px-1 rounded mr-1">(+)</span> 
                    Videos marked with this symbol have a Google Drive backup available if AP Classroom is down. Hover over the icon for details.
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Left Column: Prompt and Instructions -->
                    <div class="bg-white rounded-lg shadow-md p-5">
                        <h3 class="text-xl font-semibold mb-3 text-blue-800">1. Get the Prompt</h3>
                        
                        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                            <pre id="grok-prompt" class="whitespace-pre-wrap text-sm"></pre>
                            <div class="flex mt-4 gap-3">
                                <button id="copy-button" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy Prompt
                                </button>
                                <a href="https://grok.com" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path>
                                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path>
                                    </svg>
                                    Open Grok
                                </a>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-3 text-yellow-800">2. Video Learning Guide</h3>
                        <ol class="space-y-3 list-decimal pl-6">
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Copy the prompt</span> using the button above
                            </li>
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Open Grok</span> by clicking the button or visiting <a href="https://grok.com" target="_blank" class="text-blue-600 hover:underline">grok.com</a>
                            </li>
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Start a new conversation</span> and paste the prompt
                            </li>
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Download the PDFs</span> for your current topic (shown on the right)
                            </li>
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Attach both PDFs</span> to your Grok conversation using the paperclip icon
                            </li>
                            <li class="text-gray-700">
                                <span class="font-medium text-gray-900">Send your message</span> and start learning with Grok!
                            </li>
                        </ol>
                        
                        <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                Need Help?
                            </h4>
                            <p class="text-yellow-700 text-sm">
                                Watch our <a href="https://youtu.be/KPovHIIHfEo" target="_blank" class="text-blue-600 hover:underline">video tutorial</a> on using Grok with PDF attachments.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Right Column: Current Topic & Materials -->
                    <div>
                        <!-- Current Topic Box -->
                        <div class="bg-white rounded-lg shadow-md p-5 mb-6">
                            <h3 class="text-xl font-semibold mb-3 text-green-800" id="current-topic-header">3. Practice with Current Topic</h3>
                            <div id="current-topic-info" class="mb-4">
                                <!-- Populated by JavaScript -->
                                <p class="text-gray-500">Loading current topic information...</p>
                            </div>
                            
                            <button id="complete-current-topic-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Mark Current Topic as Completed
                            </button>
                        </div>
                        
                        <!-- All Topics Quick Access -->
                        <div class="bg-white rounded-lg shadow-md p-5">
                            <h3 class="text-xl font-semibold mb-3 text-purple-800 grok-prompt-topics-header">4. Track Your Progress</h3>
                            <div id="quick-access-topics" class="grid grid-cols-2 gap-3">
                                <!-- Populated by JavaScript -->
                                <p class="text-gray-500 col-span-2">Loading topics...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Study Materials Tab -->
            <div id="content-study-materials" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-center text-indigo-900">AP Statistics Study Materials</h2>
                <p class="text-center mb-4">Select a topic to study. Download both PDFs and attach them to your Grok conversation.</p>
                
                <div class="text-xs text-gray-600 mb-4 text-center">
                  <span class="bg-green-100 text-green-800 px-1 rounded mr-1">(+)</span> 
                  Videos marked with this symbol have a Google Drive backup available if AP Classroom is down. Hover over the icon for details.
                </div>

                <!-- All Topics Completed Message -->
                <div id="all-completed-container" class="hidden mb-6 p-6 bg-green-50 border border-green-200 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-green-700 mb-2">ðŸŽ‰ Congratulations! ðŸŽ‰</h3>
                    <p class="text-green-700 mb-4">You've completed all Unit 1 topics including the capstone Progress Check!</p>
                    <button id="reset-progress-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Reset Progress
                    </button>
                </div>

                <!-- Grok Prompt CTA Banner -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-blue-800 mb-1">Try our improved Grok Prompt tab!</h3>
                        <p class="text-blue-700 text-sm">We've updated the Grok Prompt tab with all these features in one place for a more streamlined experience.</p>
                    </div>
                    <button onclick="document.getElementById('tab-grok-prompt').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">
                        Go to Grok Prompt
                    </button>
                </div>
                
               <!-- <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <label for="topic-select" class="mr-2 font-medium text-purple-800">Track your progress:</label>
                        <select id="topic-select" class="p-2 border rounded-md">
                            <option value="">Select a topic...</option>
                        </select>
                    </div>
                    <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div> -->
                <div id="topic-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Topic cards will be dynamically inserted here -->
                </div>
                
                <div id="next-topic-container" class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg hidden">
                    <h3 class="font-bold text-lg mb-2 text-purple-800">Ready for the next topic?</h3>
                    <p class="mb-2 text-purple-700">Great job completing the current topic! Here's what to study next:</p>
                    <div id="next-topic-card" class="p-4 bg-white rounded-lg shadow-md"></div>
                </div>
            </div>
            
            <!-- Overall Progress Tab -->
            <div id="content-overall-progress" class="tab-content p-6">
                <div id="overall-progress-loading" class="text-center text-gray-500">Loading overall progress...</div>
                <div id="dot-plot-container" class="mb-6"></div>
                <div id="remaining-items" class="mb-4 text-sm text-gray-700"></div>
                <div id="flexible-quota" class="mb-4 text-sm text-gray-700"></div>
                <div id="todays-quota-status" class="mb-6 text-sm text-gray-700"></div>
                <div id="peer-quota-table-container" class="mt-6">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-800">Peer Quota Progress</h3>
                    <div id="peer-quota-loading" class="text-gray-500">Loading peer data...</div>
                    <div id="peer-quota-table"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        
        // Initialize state variable to track the currently active unit
        let currentSelectedUnitId = '1'; // Default to Unit 1 on load
                // Utility function for a simple delay
// Utility function for a simple delay (Needs to be defined)
function refreshUnitSpecificUI() {
    // Find which tab is currently active
    document.getElementById('all-completed-container').classList.add('hidden');
    if (document.getElementById('tab-study-materials').classList.contains('active')) {
        loadTopicProgress();
        populateTopicCards();
        updateAllBookmarkButtons();
    } else if (document.getElementById('tab-grok-prompt').classList.contains('active')) {
        loadTopicProgress();
        updateCurrentTopicInfo();
        populateQuickAccessTopics();
        updateAllBookmarkButtons();
    }
    // Add similar blocks for other tabs if needed
}
function updatePageTitles() {
    const fullUnitId = 'unit' + currentSelectedUnitId;
    const unitData = ALL_UNITS_DATA.find(unit => unit.unitId === fullUnitId);
    if (!unitData) return;

    // Update <title>
    document.title = `AP Statistics ${unitData.displayName || ('Unit ' + currentSelectedUnitId)}`;

    // Update <h1>
    const h1 = document.querySelector('header h1');
    if (h1) {
        h1.textContent = `AP Statistics ${unitData.displayName || ('Unit ' + currentSelectedUnitId)}`;
    }
        // Update exam weight banner
        const examWeightDiv = document.querySelector('header .bg-yellow-100');
    if (examWeightDiv && unitData.examWeight) {
        examWeightDiv.innerHTML = `<span class="font-semibold">Exam Weight:</span> ${unitData.examWeight}`;
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function updateQuotaMetVisualIndicator() {
    console.log('GH_DEBUG (VisualIndicator): ENTERING function. User ID:', currentUserId);

    if (!currentUserId) {
        console.log('GH_DEBUG (VisualIndicator): No user ID, removing class.');
        document.body.classList.remove('quota-met-today');
        return;
    }

    // Use consistent UTC date string calculation
    const todayUTC = new Date();
    const todayDateString = new Date(Date.UTC(todayUTC.getUTCFullYear(), todayUTC.getUTCMonth(), todayUTC.getUTCDate())).toISOString().split('T')[0];

    // Log the exact values being used in the query
    console.log('GH_DEBUG (VisualIndicator): Preparing query for quota date:', todayDateString, 'User ID:', currentUserId);

    try {
        // Use maybeSingle for consistency
        const { data, error } = await supabaseClient
            .from('daily_quotas_met')
            .select('id') // Select any column
            .eq('user_id', currentUserId)
            .eq('quota_date', todayDateString)
            .maybeSingle(); // Returns the single row object or null

        // Log the raw response
        console.log('GH_DEBUG (VisualIndicator): Query response:', { data, error });

        if (error) {
            console.error('GH_DEBUG (VisualIndicator): Error during SELECT query:', error);
            document.body.classList.remove('quota-met-today'); // Assume not met on error
        } else if (data) {
            // 'data' is the row object if found, null otherwise
            console.log('GH_DEBUG (VisualIndicator): SELECT found record. Applying class.');
            document.body.classList.add('quota-met-today');
        } else {
            // 'data' is null, meaning no record found
            console.log('GH_DEBUG (VisualIndicator): SELECT did NOT find record. Removing class.');
            document.body.classList.remove('quota-met-today');
        }

    } catch (err) {
       console.error('GH_DEBUG (VisualIndicator): CATCH block: Exception during SELECT attempt:', err);
       document.body.classList.remove('quota-met-today');
    }
    console.log('GH_DEBUG (VisualIndicator): EXITING function.');
}

        // Supabase initialization
        const SUPABASE_URL = 'https://rmqetzxoqupnggltuzqf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtcWV0enhvcXVwbmdnbHR1enFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MjM2NzAsImV4cCI6MjA1OTI5OTY3MH0.9I56L1kC_4JJr_u9LuDgQ2ZV5C0y_-yic828UeCiuUk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        
// --- Single Global Bookmark Functions (Supabase) ---

let currentGlobalBookmark = null; // Cache the fetched bookmark state globally within the script

// Fetch the current user's bookmark from Supabase
async function fetchCurrentUserBookmark() {
    // Ensure we have a user ID before querying
    if (!currentUserId) {
         console.log("Fetch Bookmark: No user ID.");
         return null;
    }
    console.log("Fetch Bookmark: Fetching for user ID:", currentUserId);
    try {
        // Select all columns for the user's row (should be max 1 row due to PK)
        const { data, error } = await supabaseClient
            .from('user_bookmarks')
            .select('*')
            .eq('user_id', currentUserId)
            .maybeSingle(); // Use maybeSingle() as the bookmark might not exist

        // Handle potential errors during the fetch
        if (error) {
            console.error('Error fetching bookmark:', error);
            return null; // Return null if there was an error
        }
        // Log success and return the data (bookmark object or null if none found)
        console.log("Fetch Bookmark: Data received:", data);
        return data;
    } catch (err) {
        // Catch any unexpected exceptions during the async operation
        console.error('Exception fetching bookmark:', err);
        return null;
    }
}

// Set or update the user's single bookmark in Supabase (Upsert)
async function setBookmark(unitId, itemId, itemType, itemName, itemUrl, itemAltUrl) {
    // Check if a user is logged in
    if (!currentUserId) {
        alert('Please identify yourself (enter username) to set a bookmark.');
        return; // Exit if no user
    }

    // Ensure the provided itemUrl is absolute before storing
    let absoluteItemUrl = itemUrl;
    if (itemUrl && !itemUrl.startsWith('http') && !itemUrl.startsWith('#')) {
         // If relative path (e.g., 'pdfs/unit1/file.pdf'), make it absolute based on current page
         absoluteItemUrl = new URL(itemUrl, window.location.href).href;
     } else if (itemUrl && itemUrl.startsWith('#')) {
         // If anchor link (e.g., '#topic-card-1-2'), make it absolute based on current page
         absoluteItemUrl = new URL(itemUrl, window.location.href).href;
     } // Otherwise, assume it's already an absolute URL (http...)

    // Make the alternate URL absolute if it's relative, similar to the primary URL
    let absoluteAltUrl = null;
    if (itemAltUrl) {
        if (!itemAltUrl.startsWith('http') && !itemAltUrl.startsWith('#')) {
            absoluteAltUrl = new URL(itemAltUrl, window.location.href).href;
        } else if (itemAltUrl.startsWith('#')) {
            absoluteAltUrl = new URL(itemAltUrl, window.location.href).href;
        } else {
            absoluteAltUrl = itemAltUrl;
        }
    }

    // Prepare the data object for upserting
    const bookmarkData = {
        user_id: currentUserId, // The primary key, ensures update if exists
        unit_id: unitId,
        item_id: itemId,
        item_type: itemType,
        item_name: itemName,
        item_url: absoluteItemUrl, // Store the calculated absolute URL
        item_alt_url: absoluteAltUrl // Store the alternate URL
        // 'updated_at' will be handled by the database trigger or default value
    };

    try {
        console.log('Setting bookmark with data:', bookmarkData);
        // Use upsert: inserts if no row with user_id exists, updates the existing one if it does
        const { data, error } = await supabaseClient // Capture data for immediate update
            .from('user_bookmarks')
            .upsert(bookmarkData, {
                 onConflict: 'user_id', // Specify the constraint/column for conflict resolution
                 // ignoreDuplicates: false // Default is false, meaning it updates on conflict
                 returning: "representation" // Return the inserted/updated row
             })
             .select() // Select the returned representation
             .single(); // Expect a single row back

        // Check for errors during the upsert operation
        if (error) {
            console.error('Error setting bookmark:', error);
            alert('Failed to set bookmark. Please check console and try again.');
        } else {
            console.log('Bookmark set successfully in Supabase.');
            // Update the global cache immediately to reflect the change (use returned data)
            currentGlobalBookmark = data;
            // Refresh the UI indicator and buttons
            await displayGlobalBookmarkIndicator(); // This function now calls updateAllBookmarkButtons internally
        }
    } catch (err) {
        // Catch any unexpected exceptions
        console.error('Exception setting bookmark:', err);
        alert('An error occurred while setting the bookmark.');
    }
}

// Remove the user's bookmark from Supabase
async function removeBookmark() {
    // Ensure user is logged in
    if (!currentUserId) {
        console.log("Remove Bookmark: No user ID.");
        return;
    }

    try {
        console.log('Removing bookmark for user ID:', currentUserId);
        // Delete the row matching the current user's ID
        const { error } = await supabaseClient
            .from('user_bookmarks')
            .delete()
            .eq('user_id', currentUserId); // Target the specific user's row

        // Handle potential deletion errors
        if (error) {
            console.error('Error removing bookmark:', error);
            alert('Failed to remove bookmark. Please check console and try again.');
        } else {
            console.log('Bookmark removed successfully from Supabase.');
            // Clear the global cache
            currentGlobalBookmark = null;
            // Refresh the UI indicator and buttons
            await displayGlobalBookmarkIndicator(); // This function now calls updateAllBookmarkButtons internally
        }
    } catch (err) {
        // Catch any unexpected exceptions
        console.error('Exception removing bookmark:', err);
        alert('An error occurred while removing the bookmark.');
    }
}

 // Updates the appearance of all bookmark buttons on the page
function updateAllBookmarkButtons() {
    // currentGlobalBookmark should be populated by displayGlobalBookmarkIndicator
    console.log("Updating all bookmark buttons based on state:", currentGlobalBookmark);
    document.querySelectorAll('button.bookmark-toggle-btn').forEach(button => {
        const unitId = button.dataset.bookmarkUnit;
        const itemId = button.dataset.bookmarkItem;
        const itemType = button.dataset.bookmarkType;
        const itemName = button.dataset.bookmarkName;
        const itemUrl = button.dataset.bookmarkUrl;
        const itemAltUrl = button.dataset.bookmarkAltUrl;
        let isThisTheBookmark = false;

        if (currentGlobalBookmark && unitId && itemId && itemType) {
            // Compare potentially different types (string from data attribute vs number/string from db)
            isThisTheBookmark = (
                String(currentGlobalBookmark.unit_id) === String(unitId) &&
                String(currentGlobalBookmark.item_id) === String(itemId) &&
                String(currentGlobalBookmark.item_type) === String(itemType)
            );
        }

        const icon = button.querySelector('svg');
        if (isThisTheBookmark) {
            button.classList.add('bookmarked-active');
            button.title = "This is your current bookmark (Click to remove)";
             if (icon) icon.innerHTML = `<path fill-rule="evenodd" d="M5 5a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V5z" clip-rule="evenodd"></path>`; // Filled Bookmark Icon
             // Use an IIFE or separate function to capture current values for the handler
            (function(currentButton) {
                 currentButton.onclick = (event) => {
                     event.stopPropagation(); // Prevent clicks bubbling up
                     removeBookmark();
                 };
             })(button);

        } else {
            button.classList.remove('bookmarked-active');
            button.title = "Set as Bookmark";
             if (icon) icon.innerHTML = `<path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>`; // Outlined Bookmark Icon
             // Restore onclick to SET bookmark, ensure data attributes are read correctly inside handler
             (function(currentButton, uId, iId, iType, iName, iUrl, iAltUrl) {
                  currentButton.onclick = (event) => {
                      event.stopPropagation();
                      setBookmark(uId, iId, iType, iName, iUrl, iAltUrl);
                  };
              })(button, unitId, itemId, itemType, itemName, itemUrl, itemAltUrl);
        }
    });
}


// Display the global bookmark indicator UI element
async function displayGlobalBookmarkIndicator() {
    const indicator = document.getElementById('global-bookmark-indicator');
    if (!indicator) return; // Ensure the element exists

    if (!currentUserId) {
        indicator.innerHTML = ''; // Hide if no user
        indicator.style.display = 'none';
        currentGlobalBookmark = null;
        // Update buttons even if no user (to show outlined state)
        updateAllBookmarkButtons();
        return;
    }

    indicator.innerHTML = '<span class="text-xs text-gray-500">Loading bookmark...</span>';
    indicator.style.display = 'block'; // Show while loading

    // Fetch (don't necessarily re-fetch if already cached, unless forced)
    // For simplicity on load, always fetch. Could optimize later.
    currentGlobalBookmark = await fetchCurrentUserBookmark(); // Fetch and update cache

    if (currentGlobalBookmark) {
        // URL is already absolute from Supabase
        const jumpUrl = currentGlobalBookmark.item_url;
        const jumpTarget = '_blank'; // Sensible default for external links or different pages

        // Check if the jump URL points to the *current* page's base URL + an anchor
        let isAnchorLink = false;
        try {
             const currentBaseUrl = window.location.origin + window.location.pathname;
             const bookmarkUrlObj = new URL(jumpUrl);
             const bookmarkBaseUrl = bookmarkUrlObj.origin + bookmarkUrlObj.pathname;
             if (bookmarkBaseUrl === currentBaseUrl && bookmarkUrlObj.hash) {
                 isAnchorLink = true;
             }
        } catch(e) { /* Ignore URL parsing errors */ }

        const finalJumpTarget = isAnchorLink ? '_self' : jumpTarget; // Use _self for anchors

        // Add alternate URL button if available
        const hasAltUrl = currentGlobalBookmark.item_alt_url !== null && currentGlobalBookmark.item_alt_url !== undefined;
        const altUrlButton = hasAltUrl ? `
            <a href="${currentGlobalBookmark.item_alt_url}" target="_blank" class="px-1.5 py-0.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded" title="Alternate Link (Drive/YouTube)">Alt</a>
        ` : '';

        indicator.innerHTML = `
            <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 text-sm p-2 rounded-md shadow flex items-center justify-between gap-2">
                <div class="flex items-center gap-1 overflow-hidden">
                   <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V5z" clip-rule="evenodd"></path></svg>
                   <span class="font-medium flex-shrink-0">Bookmark:</span>
                   <span class="truncate" title="${currentGlobalBookmark.item_name}">
                       ${currentGlobalBookmark.item_name} (Unit ${currentGlobalBookmark.unit_id})
                   </span>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0">
                   <a href="${jumpUrl}" target="${finalJumpTarget}" class="px-1.5 py-0.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded" title="Jump to Bookmark">Go</a>
                   ${altUrlButton}
                   <button onclick="removeBookmark()" class="px-1.5 py-0.5 bg-yellow-200 hover:bg-yellow-300 text-yellow-900 text-xs rounded" title="Clear Bookmark">Clear</button>
                </div>
            </div>
        `;
         indicator.style.display = 'block'; // Ensure visible
    } else {
        indicator.innerHTML = ''; // Clear if no bookmark
        indicator.style.display = 'none';
    }

    // Update buttons AFTER fetching/updating the global bookmark state
    updateAllBookmarkButtons();
}

// --- End Single Global Bookmark Functions ---


// Global user variables
        let currentUsername = null;
        let currentUserId = null;
        
        // User identification function
        async function identifyUser() {
            // Step 1: Get values from localStorage
            currentUsername = localStorage.getItem('apStatsUsername');
            currentUserId = parseInt(localStorage.getItem('apStatsUserId'), 10) || null;
            
            // Step 2: Check if username is null or empty
            if (!currentUsername) {
                // Ask user for their username
                const username = prompt("Enter your username (visible to others):");
                
                // If user cancels or enters nothing, return early
                if (!username) {
                    console.warn("User identification cancelled or empty username entered");
                    return;
                }
                
                // Store username and reset userId
                localStorage.setItem('apStatsUsername', username);
                currentUsername = username;
                currentUserId = null;
                localStorage.removeItem('apStatsUserId');
            }
            
            // Step 3: Validate Existing User ID (if present)
            if (currentUsername && currentUserId) {
                try {
                    // Check if the user ID exists in the database
                    const { data: userCheck, error: checkError } = await supabaseClient
                        .from('users')
                        .select('id')
                        .eq('id', currentUserId)
                        .maybeSingle();
                    
                    if (checkError) {
                        throw checkError;
                    }
                    
                    if (!userCheck) {
                        // User ID not found in database
                        console.warn('User ID found in localStorage but not in DB. Attempting to recreate user.');
                        currentUserId = null; // Force recreation logic below
                        localStorage.removeItem('apStatsUserId'); // Remove the bad ID from storage
                    } else {
                        // User ID verified in database
                        console.log(`User ID ${currentUserId} verified in DB for ${currentUsername}`);
                    }
                } catch (error) {
                    console.error('Error validating user ID in DB:', error);
                    currentUserId = null; // Set to null to be safe
                    localStorage.removeItem('apStatsUserId');
                }
            }
            
            // Step 4: Look up/Create User (if needed)
            if (currentUsername && !currentUserId) {
                try {
                    // Try to find existing user
                    const result = await supabaseClient
                        .from('users')
                        .select('id')
                        .eq('username', currentUsername)
                        .maybeSingle();
                    
                    // Handle potential errors in the query itself
                    if (result.error && result.error.message !== 'Row not found') {
                        throw result.error;
                    }
                    
                    // If user exists, store their ID
                    if (result.data) {
                        currentUserId = result.data.id;
                    } else {
                        // User not found, create new user
                        const insertResult = await supabaseClient
                            .from('users')
                            .insert({ username: currentUsername })
                            .select()
                            .single();
                        
                        // Check for insert errors
                        if (insertResult.error) {
                            throw insertResult.error;
                        }
                        
                        // Store the new user's ID
                        currentUserId = insertResult.data.id;
                    }
                    
                    // Save userId to localStorage if we have one
                    if (currentUserId) {
                        localStorage.setItem('apStatsUserId', currentUserId);
                    }
                    await updateQuotaMetVisualIndicator(); // Add this line]tVisualIndicator(); // Add this line
                    console.log(`User identified: ${currentUsername} (ID: ${currentUserId})`);
                    
                } catch (error) {
                    // Handle errors from Supabase
                    console.error("Error connecting to database:", error);
                    alert('Could not connect to online progress tracker. Progress will only be saved locally.');
                    currentUserId = null;
                }
            }
        }
        
        // Function to save completion data to Supabase
        async function saveCompletionToSupabase(itemType, itemIdentifier, unitId) {
            console.log('DEBUG: >>> Entering saveCompletionToSupabase. User ID:', currentUserId, 'Item:', itemType, 'ID:', itemIdentifier, 'Unit:', unitId);

            // Re-verify User ID inside the function
            if (!currentUserId) {
                console.warn('DEBUG: >>> No user ID found inside saveCompletionToSupabase. Skipping Supabase save.');
                return; // Exit if no user ID
            }

            // Prepare the data object
            const completionData = {
                user_id: currentUserId,
                item_type: itemType,
                item_identifier: itemIdentifier,
                unit_id: unitId,
                completed_at: new Date().toISOString()
            };
            console.log('DEBUG: >>> Preparing to insert this data:', completionData);

            // Attempt the Supabase insert using the correct client variable name
            try {
                console.log('DEBUG: >>> Calling supabaseClient.from(\'completions\').insert()...'); // Use supabaseClient
                const { data, error } = await supabaseClient // Use supabaseClient
                    .from('completions')
                    .insert(completionData);

                // Log the raw response from Supabase
                console.log('DEBUG: >>> Supabase insert response:', { data, error });

                // Check specifically for an error object in the response
                if (error) {
                    console.error('DEBUG: >>> Supabase insert returned an error object:', error);
                    // Do NOT call checkLocalQuota() if there was an error
                } else {
                    // If error is null, the operation was likely successful on Supabase's side
                    console.log(`DEBUG: >>> Completion save to Supabase seems successful: ${itemType} - ${itemIdentifier}`);
                    // Call the next step ONLY on success
                    debouncedQuotaCheck(); // Using debounced version without await
                }

            } catch (error) {
                // Catch any network errors or errors thrown from the try block
                console.error('DEBUG: >>> CATCH block: Error during Supabase insert attempt:', error);
                
                // Check if the error suggests a network problem
                if (error.message && error.message.includes('Failed to fetch')) {
                    console.log('DEBUG: Network error detected, queueing completion locally.');
                    
                    // Start a nested try/catch block for queueing logic
                    try {
                        // Get the current queue from localStorage
                        let queue = JSON.parse(localStorage.getItem('offlineCompletionQueue') || '[]');
                        
                        // Add a unique timestamp to the completionData object
                        completionData.queueTimestamp = Date.now();
                        
                        // Push the completionData object onto the queue array
                        queue.push(completionData);
                        
                        // Save the updated queue back to localStorage
                        localStorage.setItem('offlineCompletionQueue', JSON.stringify(queue));
                        
                        console.log('DEBUG: Successfully queued completion data for later sync.');
                    } catch (queueError) {
                        console.error('Failed to save completion to offline queue:', queueError);
                    }
                }
            }
            console.log('DEBUG: >>> Exiting saveCompletionToSupabase.');
        }
        
        // Function to delete completion data from Supabase
        async function deleteCompletionFromSupabase(itemType, itemIdentifier, unitId) {
            // Re-verify User ID inside the function
            if (!currentUserId) {
                console.warn('DEBUG: No user ID found. Skipping Supabase deletion.');
                return; // Exit if no user ID
            }
            
            console.log(`DEBUG: Attempting to DELETE completion: User=${currentUserId}, Type=${itemType}, ID=${itemIdentifier}, Unit=${unitId}`);
            
            try {
                const { error } = await supabaseClient
                    .from('completions')
                    .delete()
                    .match({ 
                        user_id: currentUserId, 
                        item_type: itemType, 
                        item_identifier: itemIdentifier, 
                        unit_id: unitId 
                    });
                
                if (error) {
                    console.error('DEBUG: Error deleting completion:', error);
                } else {
                    console.log('DEBUG: Successfully deleted completion from Supabase.');
                }
            } catch (error) {
                console.error('DEBUG: Exception while deleting completion from Supabase:', error);
            }
        }
        
        // Function to synchronize offline completion queue with Supabase
        async function syncOfflineQueue() {
            // Only run if we have a user ID and the browser thinks it's online
            if (!currentUserId || !navigator.onLine) return;
            
            // Read the queue from localStorage
            let queue = JSON.parse(localStorage.getItem('offlineCompletionQueue') || '[]');
            
            // If queue is empty, log and return
            if (queue.length === 0) {
                console.log("DEBUG: Offline queue is empty.");
                return;
            }
            
            // Log the sync attempt
            console.log(`DEBUG: Attempting to sync ${queue.length} items from offline queue.`);
            
            // Array to track items that were successfully synced
            let successfullySyncedTimestamps = [];
            
            // Process each item in the queue
            for (const item of queue) {
                try {
                    // Log the individual sync attempt
                    console.log("DEBUG: Attempting sync for item:", item);
                    
                    // Ensure user_id is current (safety check)
                    item.user_id = currentUserId;
                    
                    // Attempt to insert the item into Supabase
                    const { error } = await supabaseClient.from('completions').insert(item);
                    
                    // Check the response
                    if (error) {
                        // Log failure but leave item in queue
                        console.warn("DEBUG: Failed to sync item from queue:", error, item);
                    } else {
                        // Log success and track item for removal
                        console.log("DEBUG: Successfully synced item:", item);
                        successfullySyncedTimestamps.push(item.queueTimestamp);
                    }
                } catch (syncError) {
                    // Log error during sync attempt (item stays in queue)
                    console.error("DEBUG: Error during individual queue item sync attempt:", syncError, item);
                }
            }
            
            // Filter the queue to remove successfully synced items
            const newQueue = queue.filter(item => !successfullySyncedTimestamps.includes(item.queueTimestamp));
            
            // Save the updated queue back to localStorage
            localStorage.setItem('offlineCompletionQueue', JSON.stringify(newQueue));
            
            // Log final status
            console.log(`DEBUG: Offline queue sync complete. ${successfullySyncedTimestamps.length} items synced. ${newQueue.length} items remain.`);
        }
        
        // Function to synchronize local storage progress with Supabase
        async function syncLocalStorageToSupabase() {
            // Initial checks
            if (!currentUserId) {
                console.log("DEBUG (LSSync): No user ID available. Skipping sync.");
                return;
            }
            
            if (!navigator.onLine) {
                console.log("DEBUG (LSSync): Browser reports offline. Skipping sync.");
                return;
            }
            
            if (typeof ALL_UNITS_DATA === 'undefined') {
                console.log("DEBUG (LSSync): ALL_UNITS_DATA not available. Skipping sync.");
                return;
            }
            
            console.log("DEBUG (LSSync): Starting sync from Local Storage to Supabase...");
            
            try {
                // Fetch existing completions from Supabase
                console.log("DEBUG (LSSync): Fetching existing completions from Supabase...");
                const { data, error } = await supabaseClient
                    .from('completions')
                    .select('unit_id, item_identifier, item_type')
                    .eq('user_id', currentUserId);
                
                if (error) {
                    console.error("DEBUG (LSSync): Error fetching completions from Supabase:", error);
                    return;
                }
                
                // Create a Set of existing completion identifiers
                const supabaseCompletionsSet = new Set();
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        const uniqueId = `${item.unit_id}_${item.item_type}_${item.item_identifier}`;
                        supabaseCompletionsSet.add(uniqueId);
                    });
                }
                
                console.log(`DEBUG (LSSync): Found ${supabaseCompletionsSet.size} existing completions in Supabase.`);
                
                // Initialize counters
                let itemsToUploadCount = 0;
                let itemsSkippedCount = 0;
                let itemsFailedCount = 0;
                
                // Iterate through all units
                for (const unit of ALL_UNITS_DATA) {
                    // Construct the localStorage key for this unit
                    const unitNumber = unit.unitId.slice(-1); // Extract the number at the end of unitId
                    const localKey = 'apStatsUnit' + unitNumber + 'Progress';
                    
                    console.log(`DEBUG (LSSync): Checking local storage for unit ${unit.unitId} with key ${localKey}`);
                    
                    // Try to get data from localStorage
                    const localDataString = localStorage.getItem(localKey);
                    
                    if (localDataString) {
                        try {
                            // Parse the local data
                            const localUnitProgress = JSON.parse(localDataString);
                            
                            if (Array.isArray(localUnitProgress)) {
                                console.log(`DEBUG (LSSync): Found ${localUnitProgress.length} topics in local storage for unit ${unit.unitId}`);
                                
                                // Loop through each topic
                                for (const topicProgress of localUnitProgress) {
                                    // Check videos
                                    if (topicProgress.videos && Array.isArray(topicProgress.videos)) {
                                        for (const video of topicProgress.videos) {
                                            if (video.completed === true) {
                                                // Use primary URL if available, otherwise use alternate
                                                const videoUrl = video.url || video.altUrl;
                                                const uniqueId = `${unit.unitId}_video_${videoUrl}`;
                                                
                                                if (!supabaseCompletionsSet.has(uniqueId)) {
                                                    console.log(`DEBUG (LSSync): Found locally completed video missing in Supabase: ${uniqueId}`);
                                                    
                                                    // Prepare completion data
                                                    const completionData = {
                                                        user_id: currentUserId,
                                                        item_type: 'video',
                                                        item_identifier: videoUrl,
                                                        unit_id: unit.unitId,
                                                        completed_at: video.completionDate || new Date().toISOString()
                                                    };
                                                    
                                                    itemsToUploadCount++;
                                                    
                                                    try {
                                                        // Attempt to insert into Supabase
                                                        const { error } = await supabaseClient
                                                            .from('completions')
                                                            .insert(completionData);
                                                        
                                                        if (error) {
                                                            console.error(`DEBUG (LSSync): Failed to upload video completion to Supabase: ${uniqueId}`, error);
                                                            itemsFailedCount++;
                                                        } else {
                                                            console.log(`DEBUG (LSSync): Successfully uploaded video completion to Supabase: ${uniqueId}`);
                                                            // Add to set to prevent duplicate attempts
                                                            supabaseCompletionsSet.add(uniqueId);
                                                        }
                                                    } catch (insertError) {
                                                        console.error(`DEBUG (LSSync): Error during video completion upload: ${uniqueId}`, insertError);
                                                        itemsFailedCount++;
                                                    }
                                                } else {
                                                    itemsSkippedCount++;
                                                }
                                            }
                                        }
                                    }
                                    
                                    // Check quizzes
                                    if (topicProgress.quizzes && Array.isArray(topicProgress.quizzes)) {
                                        for (const quiz of topicProgress.quizzes) {
                                            if (quiz.completed === true) {
                                                const uniqueId = `${unit.unitId}_quiz_${quiz.quizId}`;
                                                
                                                if (!supabaseCompletionsSet.has(uniqueId)) {
                                                    console.log(`DEBUG (LSSync): Found locally completed quiz missing in Supabase: ${uniqueId}`);
                                                    
                                                    // Prepare completion data
                                                    const completionData = {
                                                        user_id: currentUserId,
                                                        item_type: 'quiz',
                                                        item_identifier: quiz.quizId,
                                                        unit_id: unit.unitId,
                                                        completed_at: quiz.completionDate || new Date().toISOString()
                                                    };
                                                    
                                                    itemsToUploadCount++;
                                                    
                                                    try {
                                                        // Attempt to insert into Supabase
                                                        const { error } = await supabaseClient
                                                            .from('completions')
                                                            .insert(completionData);
                                                        
                                                        if (error) {
                                                            console.error(`DEBUG (LSSync): Failed to upload quiz completion to Supabase: ${uniqueId}`, error);
                                                            itemsFailedCount++;
                                                        } else {
                                                            console.log(`DEBUG (LSSync): Successfully uploaded quiz completion to Supabase: ${uniqueId}`);
                                                            // Add to set to prevent duplicate attempts
                                                            supabaseCompletionsSet.add(uniqueId);
                                                        }
                                                    } catch (insertError) {
                                                        console.error(`DEBUG (LSSync): Error during quiz completion upload: ${uniqueId}`, insertError);
                                                        itemsFailedCount++;
                                                    }
                                                } else {
                                                    itemsSkippedCount++;
                                                }
                                            }
                                        }
                                    }
                                }
                            } else {
                                console.log(`DEBUG (LSSync): Local data for unit ${unit.unitId} is not an array. Skipping.`);
                            }
                        } catch (parseError) {
                            console.error(`DEBUG (LSSync): Error parsing local data for unit ${unit.unitId}:`, parseError);
                        }
                    } else {
                        console.log(`DEBUG (LSSync): No local data found for unit ${unit.unitId}`);
                    }
                }
                
                // Log summary
                console.log(`DEBUG (LSSync): Sync finished. Items to upload check: ${itemsToUploadCount}. Items skipped (already in DB): ${itemsSkippedCount}. Items failed to upload: ${itemsFailedCount}.`);
                
            } catch (error) {
                console.error("DEBUG (LSSync): Error during localStorage to Supabase sync:", error);
            }
        }
        
        // Flowchart Mermaid Definition
        const flowchartDefinition = `flowchart TD
    A[Start Learning Session] --> B[Gather All Materials]
    B --> C[Open Grok AI Assistant]
    C --> D[Copy & Paste Tutor Prompt]
    D --> E[Open Study Materials Tab]
    E --> F[Download Question & Answer PDFs]
    F --> G[Attach PDFs to Grok Conversation]
    G --> H["Watch Topic Video
    (Look for (+) for videos with backups)"]
    
    H --> AP{AP Classroom\\nAvailable?}
    AP -->|Yes| WA[Watch AP Classroom Video]
    AP -->|No| WG["Use Google Drive Backup Video
    (Hover over (+) for the link)"]
    WA --> I{Confused about\\nsomething?}
    WG --> I
    
    I -->|Yes| J[Pause Video]
    J --> K[Ask Grok for Help]
    K --> L[Return to Video]
    L --> I
    
    I -->|No| M[Finish Video]
    M --> N[Work Through Practice Problems with Grok]
    N --> O{All Problems\\nCompleted?}
    O -->|No| N
    O -->|Yes| P[Mark Topic as Completed]
    P --> Q{All Topics\\nCompleted?}
    Q -->|No| R[Proceed to Next Topic]
    R --> E
    Q -->|Yes| S[Tackle Capstone Challenge]
    
    classDef blueBox fill:#d4f1f9,stroke:#05b2dc,stroke-width:2px;
    classDef greenBox fill:#d8f3dc,stroke:#2d6a4f,stroke-width:2px;
    classDef yellowBox fill:#fefae0,stroke:#bc6c25,stroke-width:2px;
    classDef purpleBox fill:#e0c3fc,stroke:#7b2cbf,stroke-width:2px;
    classDef redBox fill:#ffccd5,stroke:#d90429,stroke-width:2px;
    
    class A,B,C,D blueBox;
    class E,F,G blueBox;
    class H,AP,WA,WG,I,J,K,L yellowBox;
    class M,N,O greenBox;
    class P,Q,R purpleBox;
    class S redBox;`;
        
        // Grok Prompt
        const grokPrompt = `You are an expert AP Statistics tutor. I will provide you with AP Statistics questions, which could be either multiple choice (MCQ) or free response (FRQ). For each question, I will indicate the type (MCQ or FRQ). Your task is to guide me through the questions as follows:

For MCQs:
- Present the Question: Display the multiple choice question with all answer options (A, B, C, D, E).
- Analyze My Answer: After I submit my answer:
  - If Correct: Confirm that my answer is correct and proceed to the next question.
  - If Incorrect: Identify my misconception and provide scaffolded guidance without revealing the answer.
- Provide Context (If Needed): For incorrect answers, once I arrive at the correct answer, provide relevant context.
- Summarize the Concept: Summarize the key concept being tested (only if I answered incorrectly).
- Check for Questions: Ask if I have additional questions before moving on (only if I needed guidance).

For FRQs:
- Present the Question: Display the free response question.
- Break It Down: Break down the question into smaller, scaffolded steps.
- Request Responses: For each scaffolded question, ask me to provide a response.
- Grade My Response: Evaluate my response based on the AP grading rubric.
- Guide Me: If my response is lacking, offer hints to help me improve.
- Ensure Perfection: Continue until I can provide a response that meets the rubric's requirements.
- Summarize the Concepts: Once completed correctly, summarize the key concepts.
- Check for Questions: Ask if I have additional questions before moving on.

Throughout the Session:
- Track Performance: Monitor my performance to provide personalized guidance.
- Session Summary: At the end, summarize key concepts and suggest areas for additional practice.

Thank you for helping me prepare for my AP Statistics exam!`;
        
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'default',
            securityLevel: 'loose',
            logLevel: 5,
            flowchart: { 
                useMaxWidth: true, 
                htmlLabels: true,
                curve: 'cardinal',
                diagramPadding: 8,
                nodeSpacing: 30,
                rankSpacing: 50
            }
        });
        
        // Function to render the flowchart
        function renderFlowchart() {
            const container = document.getElementById('flowchart');
            
            // Remove all children and recreate the element
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // Force re-parsing by creating and appending a new pre element
            const pre = document.createElement('pre');
            pre.className = 'mermaid';
            pre.textContent = flowchartDefinition;
            container.appendChild(pre);
            
            // Completely reinitialize mermaid for proper rendering
            try {
                mermaid.contentLoaded();
            } catch (e) {
                console.error('Mermaid parsing error:', e);
            }
        }
        
        // Study Materials and PDF Organization
        
        // Define the PDF files and organize them by topic
        ;
        
        
        // Function to create a topic card for display in the Study Materials tab
        function createTopicCard(topic, forNextTopic = false) {
            // Check if this is a capstone topic and if all previous topics are completed
            let isCapstoneLocked = false;
            if (topic.isCapstone && !forNextTopic) {
                const nonCapstonePdfs = getSelectedUnitTopics().filter(p => !p.isCapstone);
                const allPreviousCompleted = nonCapstonePdfs.every(p => 
                    p.videos.every(v => v.completed) && p.quizzes.every(q => q.completed)
                );
                isCapstoneLocked = !allPreviousCompleted;
            }
            
            // Check if all videos and quizzes in this topic are completed
            const isCompleted = topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed);
            
            // Set card classes based on topic status
            let cardClasses = 'bg-white rounded-lg shadow-md p-4 transition duration-300 ';
            if (isCompleted) {
                cardClasses += 'border-2 border-green-500 ';
            } else if (topic.isCapstone) {
                cardClasses += 'border-2 border-red-500 bg-red-50 ';
            } else if (topic.current) {
                cardClasses += 'border-2 border-blue-500 bg-blue-50 ';
            } else {
                cardClasses += 'border border-gray-200 ';
            }
            
            // Status Icon
            let statusIcon = '';
            if (isCompleted) {
                statusIcon = '<span class="text-white bg-green-500 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></span>';
            } else if (topic.isCapstone) {
                statusIcon = '<span class="text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center mr-2">ðŸ†</span>';
            } else if (topic.current) {
                statusIcon = '<span class="text-white bg-blue-500 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg></span>';
            } else {
                statusIcon = '<span class="text-gray-400 bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"></path></svg></span>';
            }
            
            // Status Badge (for display in upper right of card)
            let statusBadge = '';
            if (isCompleted) {
                statusBadge = '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Completed</span>';
            } else if (topic.isCapstone) {
                statusBadge = '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Capstone Challenge</span>';
            } else if (topic.current) {
                statusBadge = '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Current Focus</span>';
            }
            
            // Generate HTML for quiz links with checkboxes
            let quizLinksHTML = '';
            if (topic.quizzes.length > 0) {
                topic.quizzes.forEach(quiz => {
                    // Add checkbox for Questions PDF if available
                    if (quiz.questionPdf) {
                        let linkText = "Questions PDF";
                        
                        if (topic.isCapstone) {
                            if (quiz.quizId === "1-capstone_q1") {
                                linkText = "FRQ Questions";
                            } else if (quiz.quizId === "1-capstone_q2") {
                                linkText = "MCQ Part A Answers";
                            } else if (quiz.quizId === "1-capstone_q3") {
                                linkText = "MCQ Part B Answers";
                            }
                        }
                        
                        quizLinksHTML += `
                        <div class="flex items-center mb-2">
                            <input 
                                type="checkbox" 
                                id="quiz-${topic.id}-${quiz.quizId}-questions" 
                                class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                ${quiz.completed ? 'checked' : ''} 
                                data-topic-id="${topic.id}" 
                                data-item-type="quiz" 
                                data-quiz-id="${quiz.quizId}"
                                onchange="handleItemCompletionChange(event)"
                                ${isCapstoneLocked ? 'disabled' : ''}
                            >
                            <a href="${quiz.questionPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                                ${linkText}
                            </a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${topic.id}-${quiz.quizId}-q"
                                data-bookmark-type="quiz"
                                data-bookmark-name="${topic.name} - ${linkText}"
                                data-bookmark-url="${quiz.questionPdf}">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                        </div>
                        `;
                    }
                    
                    // Add checkbox for Answers PDF if available
                    if (quiz.answersPdf) {
                        const answerTitle = topic.isCapstone ? 
                            (quiz.quizId === "1-capstone_q1" ? "FRQ Answers" : 
                             quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : 
                             "MCQ Part B Answers") : "Answers PDF";
                        quizLinksHTML += `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="quiz-${topic.id}-${quiz.quizId}-answers" 
                                    class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                    ${quiz.completed ? 'checked' : ''} 
                                    data-topic-id="${topic.id}" 
                                    data-item-type="quiz" 
                                    data-quiz-id="${quiz.quizId}"
                                    onchange="handleItemCompletionChange(event)"
                                    ${isCapstoneLocked ? 'disabled' : ''}
                                >
                                <a href="${quiz.answersPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                                    ${answerTitle}
                                </a>
                                <!-- Bookmark Button -->
                                <button
                                    class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                    title="Set as Bookmark"
                                    data-bookmark-unit="${currentSelectedUnitId}"
                                    data-bookmark-item="${topic.id}-${quiz.quizId}-a"
                                    data-bookmark-type="quiz"
                                    data-bookmark-name="${topic.name} - ${answerTitle}"
                                    data-bookmark-url="${quiz.answersPdf}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        `;
                    }
                });
            }
            
            // No PDFs message if needed
            if (topic.quizzes.length === 0) {
                quizLinksHTML += `
                    <div class="p-2 bg-blue-50 rounded text-blue-700 text-sm mb-2">
                    <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        This topic has video content only (no practice PDFs)
                    </div>
                `;
            }
            
            // Generate HTML for video links with checkboxes
            let videoLinksHTML = '';
            if (topic.videos.length > 0) {
                topic.videos.forEach((video, index) => {
                    const videoNumber = topic.videos.length > 1 ? ` ${index + 1}` : '';
                    
                    if (video.url) {
                        videoLinksHTML += `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="video-${topic.id}-${index}" 
                                    class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                    ${video.completed ? 'checked' : ''} 
                                    data-topic-id="${topic.id}" 
                                    data-item-type="video" 
                                    data-item-url="${video.url}"
                                    onchange="handleItemCompletionChange(event)"
                                    ${isCapstoneLocked ? 'disabled' : ''}
                                >
                                <a href="${video.url}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 group relative flex-grow">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                                    Watch Topic Video${videoNumber}
                                    ${video.altUrl ? `
                                    <span class="ml-1 text-xs bg-green-100 text-green-800 px-1 rounded flex-shrink-0">
                            <svg class="w-3 h-3 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </span>
                            <span class="absolute top-full left-0 mt-1 hidden group-hover:block bg-white border border-gray-200 rounded p-2 shadow-md text-xs text-gray-700 w-48 z-50">
                                        If AP Classroom is down, <a href="${video.altUrl}" class="text-blue-600 hover:text-blue-800">click here</a> for the backup Google Drive video.
                        </span>
                        ` : ''}
                        <!-- Bookmark Button -->
                        <button
                            class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                            title="Set as Bookmark"
                            data-bookmark-unit="${currentSelectedUnitId}"
                            data-bookmark-item="${topic.id}-video-${index}"
                            data-bookmark-type="video"
                            data-bookmark-name="${topic.name} - Video${videoNumber}"
                            data-bookmark-url="${video.url}"
                            data-bookmark-alt-url="${video.altUrl || ''}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                            </svg>
                        </button>
                    </a>
                            </div>
                        </div>
                        `;
                    } else if (video.altUrl) {
                        videoLinksHTML += `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="video-${topic.id}-${index}-alt" 
                                    class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                    ${video.completed ? 'checked' : ''} 
                                    data-topic-id="${topic.id}" 
                                    data-item-type="video" 
                                    data-item-url="${video.altUrl}"
                                    onchange="handleItemCompletionChange(event)"
                                    ${isCapstoneLocked ? 'disabled' : ''}
                                >
                                <a href="${video.altUrl}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 flex-grow">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                                    Watch Topic Video${videoNumber} (Google Drive)
                                </a>
                                <!-- Bookmark Button -->
                                <button
                                    class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                    title="Set as Bookmark"
                                    data-bookmark-unit="${currentSelectedUnitId}"
                                    data-bookmark-item="${topic.id}-video-${index}-alt"
                                    data-bookmark-type="video"
                                    data-bookmark-name="${topic.name} - Video${videoNumber} (Google Drive)"
                                    data-bookmark-url="${video.altUrl}"
                                    data-bookmark-alt-url="${video.url || ''}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        `;
                    }
                });
            }
            
            // Create the complete card HTML
            const cardHTML = `
                <div id="topic-card-${topic.id}" class="${cardClasses}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            ${statusIcon}
                            <h3 class="text-lg font-semibold">${topic.name}</h3>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <p class="text-gray-700 mb-4">${topic.description}</p>
                    
                    ${topic.isCapstone && isCapstoneLocked ? `
                    <div class="mb-3 p-3 bg-amber-50 border border-amber-200 rounded-md text-amber-800">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 116 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Complete all other topics first!</span>
                    </div>
                    </div>
                    ` : ''}
                    
                    <div class="space-y-1 mb-3">
                        ${quizLinksHTML}
                        ${videoLinksHTML}
                    </div>
                    
                    ${isCompleted || (topic.isCapstone && isCapstoneLocked) ? '' : `
                    <button class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md mark-completed-btn" data-topic-id="${topic.id}">
                        <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Mark Topic as Completed
                    </button>
                    `}
                </div>
            `;
            
            return cardHTML;
        }
        
        // Add styling for the pulse animation and completed state
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
                100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
            }
            
            .pulse-animation {
                animation: pulse 1s ease-in-out 2;
            }
            
            .completed-state {
                opacity: 0.8;
                position: relative;
            }
            
            .completed-state::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.05);
                pointer-events: none;
                z-index: 1;
            }
            
            .completed-state .topic-card:not(.capstone-completed) {
                filter: grayscale(50%);
            }
            
            .capstone-highlight {
                border: 2px solid #ef4444 !important;
                box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2), 0 2px 4px -1px rgba(239, 68, 68, 0.1) !important;
            }
        `;
        document.head.appendChild(style);
        
        // Function to check if all topics are completed
        function checkAllTopicsCompleted() {
    // Use the topics for the currently selected unit
    const topics = getSelectedUnitTopics();
    let totalItems = 0;
    let completedItems = 0;
    
    topics.forEach(topic => {
        // Count videos
        topic.videos.forEach(video => {
            totalItems++;
            if (video.completed) completedItems++;
        });
        
        // Count quizzes
        topic.quizzes.forEach(quiz => {
            totalItems++;
            if (quiz.completed) completedItems++;
        });
    });
    
    // All items are completed if we have items and all of them are completed
    const allCompleted = totalItems > 0 && completedItems === totalItems;
    
    const completedContainer = document.getElementById('all-completed-container');
    const topicCardsContainer = document.getElementById('topic-cards-container');
    const studyMaterialsTab = document.getElementById('content-study-materials');
    
    if (allCompleted) {
        // Show completion message
        completedContainer.classList.remove('hidden');
        
        // Hide the next topic container
        document.getElementById('next-topic-container').classList.add('hidden');
        
        // Add completed state styling to the cards container
        topicCardsContainer.classList.add('completed-state');
        
        // Find the capstone topic card and highlight it
        const capstoneCard = document.getElementById(`topic-card-exam-frq2`);
        if (capstoneCard) {
            capstoneCard.classList.add('capstone-highlight');
        }
        
        // Add a subtle completion state to the entire tab
        studyMaterialsTab.classList.add('bg-green-50');
    } else {
        // Hide completion message
        completedContainer.classList.add('hidden');
        
        // Remove completed state styling
        topicCardsContainer.classList.remove('completed-state');
        studyMaterialsTab.classList.remove('bg-green-50');
        
        // Remove capstone highlight
        const capstoneCard = document.getElementById(`topic-card-exam-frq2`);
        if (capstoneCard) {
            capstoneCard.classList.remove('capstone-highlight');
        }
    }
    
    return allCompleted;
}
        // Function to reset all progress
        function resetProgress() {
            // Confirm reset
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                // Reset all topics to not completed
                getSelectedUnitTopics().forEach((topic, index) => {
                    // Reset all video and quiz completion statuses
                    topic.videos.forEach(video => {
                        video.completed = false;
                        video.completionDate = null;
                    });
                    topic.quizzes.forEach(quiz => {
                        quiz.completed = false;
                        quiz.completionDate = null;
                    });
                    
                    topic.current = index === 0; // Set first topic as current
                });
                
                // Save to local storage
                saveTopicProgress();
                
                // Reset section headers
                const currentTopicHeader = document.getElementById('current-topic-header');
                if (currentTopicHeader) {
                    currentTopicHeader.textContent = '2. Get Your Current Topic Materials';
                }
                
                const topicsHeader = document.querySelector('.grok-prompt-topics-header');
                if (topicsHeader) {
                    topicsHeader.textContent = 'Quick Access to All Topics';
                }
                
                // Refresh the UI for both tabs
                populateTopicCards(); // For study materials tab
                updateCurrentTopicInfo(); // For grok prompt tab
                populateQuickAccessTopics(); // For grok prompt tab
                updateAllBookmarkButtons(); // Update bookmark buttons
                
                // Hide completion message in study materials tab
                document.getElementById('all-completed-container').classList.add('hidden');
                
                // Scroll to the first topic if on study materials tab
                const firstCard = document.getElementById(`topic-card-${getSelectedUnitTopics()[0].id}`);
                if (firstCard && document.getElementById('content-study-materials').classList.contains('active')) {
                    firstCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        // Function to populate the topic cards
        function populateTopicCards() {
            document.getElementById('all-completed-container').classList.add('hidden');
            const container = document.getElementById('topic-cards-container');
            if (!container) {
                console.log('Error: topic-cards-container not found');
                return;
            }
            
            container.innerHTML = '';
            
            // Find the first incomplete topic
            const nextIncompleteIndex = getSelectedUnitTopics().findIndex(topic => {
                return !topic.videos.every(v => v.completed) || !topic.quizzes.every(q => q.completed);
            });
            
            // Mark it as current unless all topics are completed
            if (nextIncompleteIndex >= 0) {
                getSelectedUnitTopics().forEach((topic, index) => {
                    topic.current = index === nextIncompleteIndex;
                });
            }
            
            // Populate the cards in the original order (sequential)
            getSelectedUnitTopics().forEach((topic, index) => {
                const isNext = index === nextIncompleteIndex;
                // We need to create a real DOM element from the HTML string
                const cardHTML = createTopicCard(topic, isNext);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;
                const cardElement = tempDiv.firstElementChild;
                
                // Add event listeners to the mark-completed buttons
                const completeButton = cardElement.querySelector('.mark-completed-btn');
                if (completeButton) {
                    completeButton.addEventListener('click', function() {
                        const topicId = this.getAttribute('data-topic-id');
                        markTopicAsCompleted(topicId);
                    });
                }
                
                container.appendChild(cardElement);
            });
            
            updateProgressBar();
            populateTopicSelect();
            checkAllTopicsCompleted();
        }
        
        // Function to populate the topic select dropdown
        function populateTopicSelect() {
            const select = document.getElementById('topic-select');
            select.innerHTML = '<option value="">Select a topic...</option>';
            
            getSelectedUnitTopics().forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = topic.name;
                select.appendChild(option);
            });
            
            // Add event listener to handle selection
            select.addEventListener('change', function() {
                const selectedTopicId = this.value;
                if (!selectedTopicId) return;
                
                // Scroll to the selected topic card
                const card = document.getElementById(`topic-card-${selectedTopicId}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('pulse-animation');
                    setTimeout(() => {
                        card.classList.remove('pulse-animation');
                    }, 2000);
                }
            });
        }
        
        // Function to mark a specific video as completed or not completed
        function markVideoComplete(topicId, videoUrl, isCompleted) {
            // Find the topic
            const topic = getSelectedUnitTopics().find(t => t.id === topicId);
            if (!topic) return;
            
            // Find the video object
            const video = topic.videos.find(v => v.url === videoUrl || v.altUrl === videoUrl);
            if (!video) return;
            
            // Update the video's completion status
            video.completed = isCompleted;
            video.completionDate = isCompleted ? new Date().toISOString() : null;
            
            // Save to localStorage
            saveTopicProgress();
            
            // Refresh UI
            populateTopicCards();
            updateCurrentTopicInfo();
            populateQuickAccessTopics();
            updateAllBookmarkButtons();
            updateProgressBar();
            
            console.log(`DEBUG: Before Supabase Check. currentUserId:`, currentUserId, `isCompleted:`, isCompleted); // Updated log
            if (currentUserId) {
                if (isCompleted) { // ADD THIS CHECK
                    console.log('DEBUG: Item marked complete, attempting to save to Supabase...');
                    saveCompletionToSupabase('video', videoUrl, currentSelectedUnitId); // Pass correct itemType/identifier
                } else {
                    // Item marked incomplete - Call delete function
                    console.log('DEBUG: Item marked incomplete. Attempting to delete from Supabase...');
                    deleteCompletionFromSupabase('video', videoUrl, currentSelectedUnitId);
                }
            }
            
            // Call placeholder function for checking local storage quota
            debouncedQuotaCheck();
        }
        
        // Function to mark a specific quiz as completed or not completed
        function markQuizComplete(topicId, quizId, isCompleted) {
            // Find the topic
            const topic = getSelectedUnitTopics().find(t => t.id === topicId);
            if (!topic) return;
            
            // Find the quiz object
            const quiz = topic.quizzes.find(q => q.quizId === quizId);
            if (!quiz) return;
            
            // Update the quiz's completion status
            quiz.completed = isCompleted;
            quiz.completionDate = isCompleted ? new Date().toISOString() : null;
            
            // Save to localStorage
            saveTopicProgress();
            
            // Refresh UI
            populateTopicCards();
            updateCurrentTopicInfo();
            populateQuickAccessTopics();
            updateAllBookmarkButtons();
            updateProgressBar();
            
            console.log(`DEBUG: Before Supabase Check. currentUserId:`, currentUserId, `isCompleted:`, isCompleted); // Updated log
            if (currentUserId) {
                if (isCompleted) { // ADD THIS CHECK
                    console.log('DEBUG: Item marked complete, attempting to save to Supabase...');
                    saveCompletionToSupabase('quiz', quizId, currentSelectedUnitId); // Pass correct itemType/identifier
                } else {
                    // Item marked incomplete - Call delete function
                    console.log('DEBUG: Item marked incomplete. Attempting to delete from Supabase...');
                    deleteCompletionFromSupabase('quiz', quizId, currentSelectedUnitId);
                }
            }
            
            // Call placeholder function for checking local storage quota
            debouncedQuotaCheck();
        }
        
        
        // Function to check if daily quota has been met and record it in Supabase
        async function _performQuotaCheck() {
            console.log("DEBUG (_performQuotaCheck): Debounced check running...");
            if (!currentUserId) {
                console.log('DEBUG (QuotaCheck): Cannot check daily quota without user ID.');
                // Ensure visual consistency when no user
                document.body.classList.remove('quota-met-today'); // Remove class if no user
                // We might still call the visual indicator update in case it was previously set
                await updateQuotaMetVisualIndicator();
                return;
            }

            console.log('DEBUG (QuotaCheck): Calculating dynamic quota targets...');
            const { requiredVideosPerDay, requiredQuizzesPerDay, error: quotaError } = await calculateDynamicQuota();

            if (quotaError) {
                console.error(`DEBUG (QuotaCheck): Failed to calculate dynamic quota: ${quotaError}. Aborting check.`);
                // Ensure visual reflects calculation failure
                document.body.classList.remove('quota-met-today');
                await updateQuotaMetVisualIndicator(); // Update display based on failed calc state
                return;
            }
            console.log(`DEBUG (QuotaCheck): Dynamic targets: Videos=${requiredVideosPerDay}, Quizzes=${requiredQuizzesPerDay}`);


            // Get today's date boundaries using UTC
            const now = new Date();
            const startOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
            const endOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999));
            const todayDateString = startOfDayUTC.toISOString().split('T')[0];

            console.log(`DEBUG: Checking completions for UTC date ${todayDateString} from ${startOfDayUTC.toISOString()} to ${endOfDayUTC.toISOString()}`);

            try {
                // Fetch completions (best effort)
                const { data: completionsData, error: completionsError } = await supabaseClient
                    .from('completions')
                    .select('item_type')
                    .eq('user_id', currentUserId)
                    .gte('completed_at', startOfDayUTC.toISOString())
                    .lte('completed_at', endOfDayUTC.toISOString());

                if (completionsError) {
                    console.error('Error fetching today\'s completions:', completionsError);
                    // Continue, but counts will be 0
                }

                const videosToday = completionsData ? completionsData.filter(item => item.item_type === 'video').length : 0;
                const quizzesToday = completionsData ? completionsData.filter(item => item.item_type === 'quiz').length : 0;
                console.log(`DEBUG (QuotaCheck): Fetched counts for today: Videos=${videosToday}, Quizzes=${quizzesToday}`);

                const quotaMetNow = videosToday >= requiredVideosPerDay && quizzesToday >= requiredQuizzesPerDay;
                console.log(`DEBUG: Quota met now (dynamic)? ${quotaMetNow}`);

                // Query Existing Status (best effort read)
                let recordExists = false; // Assume false initially
                try {
                    const { data: quotaStatusData, error: quotaStatusError } = await supabaseClient
                        .from('daily_quotas_met')
                        .select('id') // <-- Line Changed Here
                        .eq('user_id', currentUserId)
                        .eq('quota_date', todayDateString)
                        .maybeSingle(); // Keep maybeSingle

                    if (quotaStatusError) {
                        console.warn('WARN (QuotaCheck): Could not reliably check existing quota record:', quotaStatusError.message);
                        // Proceed cautiously, might attempt insert even if record exists
                    } else {
                        recordExists = (quotaStatusData !== null);
                        console.log(`DEBUG (QuotaCheck - DB Read): Record exists for today? ${recordExists}`);
                    }
                } catch (readError) {
                    console.error('ERROR (QuotaCheck): Exception during quota status read:', readError);
                     // Proceed cautiously
                }


                // --- Core Logic: Attempt Write/Delete and Set UI based on ACTION outcome ---
                if (quotaMetNow) {
                    // We believe the quota is met, ensure the record exists
                    if (!recordExists) {
                        // Attempt to INSERT because our read didn't find it
                        console.log("DEBUG (QuotaCheck - DB): Attempting to INSERT quota record (as read found none)...");
                        const { error: insertError } = await supabaseClient
                            .from('daily_quotas_met')
                            .insert({ user_id: currentUserId, quota_date: todayDateString });

                        if (insertError) {
                            const isConflict = insertError.code === '23505' || (insertError.message && insertError.message.includes('duplicate key value violates unique constraint'));
                            if (isConflict) {
                                console.log('DEBUG (QuotaCheck - DB): INSERT failed with Conflict (409). Record MUST exist.');
                                // *** UI UPDATE: Trust the conflict ***
                                document.body.classList.add('quota-met-today');
                            } else {
                                console.error(`DEBUG (QuotaCheck - DB): INSERT failed for other reason: ${insertError.message}`);
                                // UI UPDATE: Reflect insert failure
                                document.body.classList.remove('quota-met-today');
                            }
                        } else {
                            // INSERT Successful
                            console.log('DEBUG (QuotaCheck - DB): INSERT successful.');
                            // *** UI UPDATE: Trust the success ***
                            document.body.classList.add('quota-met-today');
                        }
                    } else {
                        // Read found the record exists, quota is met. Ensure UI is correct.
                        console.log("DEBUG (QuotaCheck - DB): Read found record exists and quota is met. Ensuring UI state.");
                        // *** UI UPDATE: Trust the read (since no conflicting write needed) ***
                        document.body.classList.add('quota-met-today');
                    }
                } else {
                    // Quota is NOT met now. If record exists, delete it.
                    if (recordExists) {
                        console.log("DEBUG (QuotaCheck - DB): Quota NOT met, attempting to DELETE existing record...");
                        const { error: deleteError } = await supabaseClient
                            .from('daily_quotas_met')
                            .delete()
                            .match({ user_id: currentUserId, quota_date: todayDateString });

                        if (deleteError) {
                            console.error('Error deleting quota record:', deleteError);
                            // Don't change UI state optimistically if delete fails
                        } else {
                            console.log('DEBUG (QuotaCheck - DB): DELETE successful.');
                            // *** UI UPDATE: Trust the delete ***
                            document.body.classList.remove('quota-met-today');
                        }
                    } else {
                        // Quota not met, record doesn't exist. Ensure UI is correct.
                        console.log("DEBUG (QuotaCheck - DB): Quota NOT met, no record found. Ensuring UI state.");
                         // *** UI UPDATE: Ensure class is removed ***
                         document.body.classList.remove('quota-met-today');
                    }
                }

            } catch (outerError) { // Catch for the main try block
                console.error('Error during overall quota check process:', outerError);
                // Don't assume UI state on error, let subsequent reads handle it if possible
                // or maybe remove class to be safe? Let's remove it.
                document.body.classList.remove('quota-met-today');
            }

            // Final call to update display elements based on potentially more consistent (later) reads
            console.log('DEBUG (QuotaCheck): Finished check logic, calling displayDailyQuotaStatus for UI text/bars.');
            await displayDailyQuotaStatus(); // Update the text/progress bars
            // We no longer need the final visual indicator update here, as the class is set above
        }
        
        // Create the debounced version of the quota check function
        // It will wait 750ms after the *last* call before executing _performQuotaCheck
        const debouncedQuotaCheck = debounce(_performQuotaCheck, 750);
        
        // Create a debounced version of the quota check function (500ms wait time)
        const _debouncedQuotaCheck = debounce(_performQuotaCheck, 500);
        
        // Function that external code calls to trigger a quota check
        // This implementation uses the debounced version to prevent rapid multiple calls
        async function _triggerDebouncedQuotaCheck() {
            console.log('DEBUG: checkDailyQuotaCompletion called, using debounced implementation');
            _debouncedQuotaCheck();
            // This returns immediately while the debounced function waits before executing
        }
        
        // Alias function for backward compatibility
        async function checkDailyQuotaCompletion() {
            return _triggerDebouncedQuotaCheck();
        }
        
        // Function to mark all videos and quizzes in a topic as completed
        // Function to mark all videos and quizzes in a topic as completed
        async function markTopicAsCompleted(topicId) {
            const topic = getSelectedUnitTopics().find(t => t.id === topicId);
            if (!topic) return;

            console.log(`DEBUG (markTopic): Marking topic ${topicId} as completed.`);

            // --- NEW: Track items to save to Supabase ---
            const itemsToSave = [];

            // Mark all videos as completed and queue for saving
            topic.videos.forEach(video => {
                // Only mark/save if not already completed
                if (!video.completed) {
                    video.completed = true;
                    video.completionDate = video.completionDate || new Date().toISOString();
                    const videoIdentifier = video.url || video.altUrl;
                    if (videoIdentifier) {
                        itemsToSave.push({ type: 'video', identifier: videoIdentifier });
                        console.log(`DEBUG (markTopic): Queued video ${videoIdentifier} for saving.`);
                    } else {
                         console.warn(`DEBUG (markTopic): Skipping video in topic ${topicId} due to missing identifier.`);
                    }
                }
            });

            // Mark all quizzes as completed and queue for saving
            topic.quizzes.forEach(quiz => {
                 // Only mark/save if not already completed
                if (!quiz.completed) {
                    quiz.completed = true;
                    quiz.completionDate = quiz.completionDate || new Date().toISOString();
                    itemsToSave.push({ type: 'quiz', identifier: quiz.quizId });
                    console.log(`DEBUG (markTopic): Queued quiz ${quiz.quizId} for saving.`);
                }
            });

            topic.current = false;

            // Automatically mark the next topic as current
            const currentIndex = getSelectedUnitTopics().findIndex(t => t.id === topicId);
            if (currentIndex >= 0 && currentIndex < getSelectedUnitTopics().length - 1) {
                const nextTopic = getSelectedUnitTopics()[currentIndex + 1];
                if (nextTopic) {
                    nextTopic.current = true;
                }
            }

            // Update local storage FIRST to persist completion status locally
            saveTopicProgress();
             console.log(`DEBUG (markTopic): Local progress saved for topic ${topicId}.`);

            // --- NEW: Save queued items to Supabase ---
            if (currentUserId && itemsToSave.length > 0) {
                 console.log(`DEBUG (markTopic): Attempting to save ${itemsToSave.length} items to Supabase for user ${currentUserId}.`);
                // Use Promise.allSettled to attempt all saves even if some fail
                Promise.allSettled(itemsToSave.map(item =>
                    saveCompletionToSupabase(item.type, item.identifier, currentSelectedUnitId)
                )).then(async results => {
                    // Log results (optional)
                    results.forEach((result, index) => {
                        const item = itemsToSave[index];
                        if (result.status === 'fulfilled') {
                            console.log(`DEBUG (markTopic): Successfully saved ${item.type} ${item.identifier} to Supabase.`);
                        } else {
                            console.error(`DEBUG (markTopic): Failed to save ${item.type} ${item.identifier} to Supabase:`, result.reason);
                        }
                    });
                     // Check quota AFTER attempting Supabase saves
                     console.log(`DEBUG (markTopic): Triggering quota check after Supabase saves.`);
                     await checkDailyQuotaCompletion();
                });
            } else if (itemsToSave.length > 0) {
                // If no user ID, we rely on the local storage update and potential future sync
                console.warn(`DEBUG (markTopic): No user ID or no items needed saving to Supabase. Local state updated.`);
                // Check local quota based on local state change if needed (though checkDailyQuotaCompletion primarily uses Supabase now)
                // checkDailyQuotaCompletion(); // Maybe call this anyway if you want local visual updates? It might double-trigger if Supabase succeeds later.
                 console.log(`DEBUG (markTopic): Triggering quota check even without Supabase saves (may rely on local logic if implemented).`);
                 await checkDailyQuotaCompletion(); // Call it regardless to update visuals based on fetched data
            } else {
                 console.log(`DEBUG (markTopic): No new items were marked complete.`);
                 // Check quota anyway, in case this function is called when topic already complete
                 console.log(`DEBUG (markTopic): Triggering quota check (topic might have been already complete).`);
                 await checkDailyQuotaCompletion();
            }


            // Refresh the UI immediately based on local changes
            populateTopicCards();
            updateCurrentTopicInfo();
            populateQuickAccessTopics();
            updateAllBookmarkButtons();
            updateProgressBar();

            // Scroll to next topic in study materials tab if applicable
            if (currentIndex >= 0 && currentIndex < getSelectedUnitTopics().length - 1 && document.getElementById('content-study-materials').classList.contains('active')) {
                const nextCard = document.getElementById(`topic-card-${getSelectedUnitTopics()[currentIndex + 1]?.id}`);
                if (nextCard) {
                    setTimeout(() => {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100); // Small delay allows UI to update first
                }
            }
        }
        
        // Function to update the next topic section
        function updateNextTopic() {
            const nextTopicContainer = document.getElementById('next-topic-container');
            const nextTopicCard = document.getElementById('next-topic-card');
            
            // Check if all topics are completed
            if (checkAllTopicsCompleted()) {
                nextTopicContainer.classList.add('hidden');
                return;
            }
            
            // Find the first incomplete topic
            const nextIncompleteIndex = getSelectedUnitTopics().findIndex(topic => !topic.completed);
            
            if (nextIncompleteIndex >= 0) {
                nextTopicContainer.classList.remove('hidden');
                nextTopicCard.innerHTML = '';
                nextTopicCard.appendChild(createTopicCard(getSelectedUnitTopics()[nextIncompleteIndex], true));
            } else {
                nextTopicContainer.classList.add('hidden');
            }
        }
        
        // Function to update the progress bar
        function updateProgressBar() {
            // Update progress bar based on completed topics
            const progressBar = document.getElementById('progress-bar');
            if (!progressBar) return;
            
            // Count completed topics and total topics excluding capstone
            const nonCapstonePdfs = getSelectedUnitTopics().filter(p => !p.isCapstone);
            const completedTopics = nonCapstonePdfs.filter(topic => 
                topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed)
            ).length;
            const totalTopics = nonCapstonePdfs.length;
            
            // Calculate percentage
            const progressPercentage = Math.round((completedTopics / totalTopics) * 100);
            
            // Update width and text
            progressBar.style.width = `${progressPercentage}%`;
            
            // Decide on color based on progress
            if (progressPercentage < 30) {
                progressBar.classList.add('bg-red-500');
                progressBar.classList.remove('bg-yellow-500', 'bg-green-500');
            } else if (progressPercentage < 70) {
                progressBar.classList.add('bg-yellow-500');
                progressBar.classList.remove('bg-red-500', 'bg-green-500');
            } else {
                progressBar.classList.add('bg-green-500');
                progressBar.classList.remove('bg-red-500', 'bg-yellow-500');
            }
            
            // Update text
            document.getElementById('progress-text').textContent = `${completedTopics} of ${totalTopics} topics completed (${progressPercentage}%)`;
        }
        
        // Centralize Topic Data Access: Helper function to get topics for the current selected unit
        function getSelectedUnitTopics() {
            // Construct the expected unitId format (e.g., 'unit1', 'unit2')
            const fullUnitId = 'unit' + currentSelectedUnitId;
            const unitData = ALL_UNITS_DATA.find(unit => unit.unitId === fullUnitId);
            // Handle potential errors if unit data is not found or invalid
            if (!unitData || !Array.isArray(unitData.topics)) {
                console.error(`Topics not found or invalid for unitId: ${fullUnitId}`);
                return []; // Return empty array to prevent crashes
            }
            return unitData.topics; // Return the topics array for the selected unit
        }
        
        // Function to save topic progress to local storage
        function saveTopicProgress() {
            const progress = getSelectedUnitTopics().map(topic => ({
                id: topic.id,
                completed: topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed),
                current: topic.current,
                videos: topic.videos.map(video => ({
                    url: video.url,
                    altUrl: video.altUrl,
                    completed: video.completed,
                    completionDate: video.completionDate
                })),
                quizzes: topic.quizzes.map(quiz => ({
                    quizId: quiz.quizId,
                    completed: quiz.completed,
                    completionDate: quiz.completionDate
                }))
            }));
            
            localStorage.setItem('apStatsUnit' + currentSelectedUnitId + 'Progress', JSON.stringify(progress));
        }
        
        // Function to load topic progress from local storage
        function loadTopicProgress() {
            const savedProgress = localStorage.getItem('apStatsUnit' + currentSelectedUnitId + 'Progress');
            
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                
                // Update the getSelectedUnitTopics() array with saved progress
                    progress.forEach(savedTopic => {
                    const topic = getSelectedUnitTopics().find(t => t.id === savedTopic.id);
                        if (topic) {
                            // A topic is considered completed if all its videos and quizzes are completed
                            // or if it was previously marked as completed in the old structure
                            topic.current = savedTopic.current;
                            
                            // Update video completion statuses if present
                            if (savedTopic.videos && Array.isArray(savedTopic.videos)) {
                                savedTopic.videos.forEach((savedVideo, index) => {
                                    // Match videos by URL if possible, otherwise by index
                                    const videoMatch = topic.videos.find(v => v.url === savedVideo.url) || 
                                                     (index < topic.videos.length ? topic.videos[index] : null);
                                    if (videoMatch) {
                                        videoMatch.completed = savedVideo.completed;
                                        videoMatch.completionDate = savedVideo.completionDate;
                                    }
                                });
                            }
                            
                            // Update quiz completion statuses if present
                            if (savedTopic.quizzes && Array.isArray(savedTopic.quizzes)) {
                                savedTopic.quizzes.forEach((savedQuiz, index) => {
                                    // Match quizzes by ID if possible, otherwise by index
                                    const quizMatch = topic.quizzes.find(q => q.quizId === savedQuiz.quizId) || 
                                                      (index < topic.quizzes.length ? topic.quizzes[index] : null);
                                    if (quizMatch) {
                                        quizMatch.completed = savedQuiz.completed;
                                        quizMatch.completionDate = savedQuiz.completionDate;
                                    }
                                });
                            }
                            
                            // Handle legacy format (before restructuring)
                            if (typeof savedTopic.completed === 'boolean') {
                                if (savedTopic.completed) {
                                    // Mark all videos and quizzes as completed for this topic
                                    topic.videos.forEach(video => {
                                        video.completed = true;
                                        video.completionDate = video.completionDate || new Date().toISOString();
                                    });
                                    topic.quizzes.forEach(quiz => {
                                    quiz.completed = true;
                                    quiz.completionDate = quiz.completionDate || new Date().toISOString();
                                });
                            }
                        }
                    }
                });
            }
        }
        
        // Document ready function
        document.addEventListener('DOMContentLoaded', async function() {
            // Call identifyUser first
            await identifyUser();

            await displayGlobalBookmarkIndicator(); // Load and display early

            
            // Attempt to sync offline queue if user is identified
            if (currentUserId) {
                await syncOfflineQueue();
                // await syncLocalStorageToSupabase(); // Disabled to prevent potential duplicate entries from race conditions
            }
            
            // --- Generate QR Code ---
            try {
                const qrCodeContainer = document.getElementById('qrcode-container');
                const currentUrl = window.location.href; // Get the current page URL dynamically
                
                if (qrCodeContainer && typeof QRCode !== 'undefined') {
                     // Clear previous QR code if any (useful for testing/reloads)
                     qrCodeContainer.innerHTML = ''; 
                     
                     new QRCode(qrCodeContainer, {
                        text: currentUrl,
                        width: 180, // ADJUSTED SIZE
                        height: 180, // ADJUSTED SIZE
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H // High correction level
                     });
                     console.log('DEBUG: QR Code generated for URL:', currentUrl);
                } else {
                     console.error('ERROR: QR Code container or library not found.');
                     if(qrCodeContainer) qrCodeContainer.innerHTML = '<p class="text-red-500 text-xs p-2">Error loading QR code.</p>';
                }
            } catch(qrError) {
                 console.error('ERROR: Failed to generate QR code:', qrError);
                 const qrCodeContainer = document.getElementById('qrcode-container');
                 if(qrCodeContainer) qrCodeContainer.innerHTML = '<p class="text-red-500 text-xs p-2">Error generating QR code.</p>';
            }
            // --- End Generate QR Code ---
            
            // Set Grok prompt content
            document.getElementById('grok-prompt').textContent = grokPrompt;
            
            // Tab Switching Logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Update active tab button
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // Update active content
                    const contentId = button.id.replace('tab-', 'content-');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(contentId).classList.add('active');
                    
                    // Always render mermaid chart if flowchart tab, whether it was previously active or not
                    if (button.id === 'tab-flowchart') {
                        // Small delay to ensure the tab content is visible before rendering
                        setTimeout(renderFlowchart, 50);
                    }
                    
                    // Initialize topic cards if study materials tab
                    if (button.id === 'tab-study-materials') {
                        loadTopicProgress();
                        populateTopicCards();
                        updateAllBookmarkButtons();
                    }
                    
                    // Update current topic info and quick access topics if grok prompt tab
                    if (button.id === 'tab-grok-prompt') {
                        loadTopicProgress();
                        updateCurrentTopicInfo();
                        updateAllBookmarkButtons();
                        populateQuickAccessTopics();
                        updateAllBookmarkButtons();
                    }
                    
                    // Call displayOverallProgress if overall progress tab
                    if (button.id === 'tab-overall-progress') {
                        displayOverallProgress();
                    }
                });
            });
            
            // Copy to clipboard functionality
            document.getElementById('copy-button').addEventListener('click', () => {
                const promptText = document.getElementById('grok-prompt').textContent;
                const button = document.getElementById('copy-button');
                
                // Show loading state
                button.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Copying...
                `;
                
                // Use the Clipboard API with fallback methods
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    // Modern browsers
                    navigator.clipboard.writeText(promptText)
                        .then(() => {
                            button.innerHTML = `
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Copied!
                            `;
                            button.classList.add('bg-green-500');
                            button.classList.remove('bg-blue-500');
                            
                            setTimeout(() => {
                                button.innerHTML = `
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy Prompt
                                `;
                                button.classList.add('bg-blue-500');
                                button.classList.remove('bg-green-500');
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy text: ', err);
                            button.innerHTML = `
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 01-1-1V9a1 1 0 012 0v4a1 1 0 01-1 1zm0-8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                </svg>
                                Failed to copy
                            `;
                            button.classList.add('bg-red-500');
                            button.classList.remove('bg-blue-500');
                            
                            setTimeout(() => {
                                button.innerHTML = `
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy Prompt
                                `;
                                button.classList.add('bg-blue-500');
                                button.classList.remove('bg-red-500');
                            }, 2000);
                            
                            alert('Failed to copy to clipboard. Please select and copy the text manually.');
                        });
                } else {
                    // Fallback for older browsers
                    try {
                        // Create a temporary textarea element
                        const textarea = document.createElement('textarea');
                        textarea.value = promptText;
                        textarea.setAttribute('readonly', '');
                        textarea.style.position = 'absolute';
                        textarea.style.left = '-9999px';
                        document.body.appendChild(textarea);
                        
                        // Select and copy the text
                        textarea.select();
                        document.execCommand('copy');
                        
                        // Remove the textarea
                        document.body.removeChild(textarea);
                        
                        // Update button styles
                        button.innerHTML = `
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            Copied!
                        `;
                        button.classList.add('bg-green-500');
                        button.classList.remove('bg-blue-500');
                        
                        setTimeout(() => {
                            button.innerHTML = `
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy Prompt
                            `;
                            button.classList.add('bg-blue-500');
                            button.classList.remove('bg-green-500');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        button.innerHTML = `
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 01-1-1V9a1 1 0 012 0v4a1 1 0 01-1 1zm0-8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                            </svg>
                            Failed to copy
                        `;
                        button.classList.add('bg-red-500');
                        button.classList.remove('bg-blue-500');
                        
                        setTimeout(() => {
                            button.innerHTML = `
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy Prompt
                            `;
                            button.classList.add('bg-blue-500');
                            button.classList.remove('bg-red-500');
                        }, 2000);
                        
                        alert('Failed to copy to clipboard. Please select and copy the text manually.');
                    }
                }
            });
            
            // Reset progress button functionality
            document.getElementById('reset-progress-btn').addEventListener('click', resetProgress);
            
            // Auto-render flowchart if that tab is initially selected
            if (document.getElementById('tab-flowchart').classList.contains('active')) {
                renderFlowchart();
            }
            
            // Initialize study materials if that tab is initially selected
            if (document.getElementById('tab-study-materials').classList.contains('active')) {
                loadTopicProgress();
                populateTopicCards();
                updateAllBookmarkButtons();
            }
            
            // Initialize grok prompt tab if that tab is initially selected
            if (document.getElementById('tab-grok-prompt').classList.contains('active')) {
                loadTopicProgress();
                updateCurrentTopicInfo();
                updateAllBookmarkButtons();
                populateQuickAccessTopics();
                updateAllBookmarkButtons();
            }
            
            // Initialize overall progress tab if that tab is initially selected
            if (document.getElementById('tab-overall-progress').classList.contains('active')) {
                displayOverallProgress();
            }
            
            // Initialize with the study materials tab active
            document.getElementById('tab-study-materials').click();
            
            // Call initial functions for first tab state
            loadTopicProgress();
            populateTopicCards();
            
            updateAllBookmarkButtons(); // Update buttons AFTER rendering
               // Unit Switching Logic
   document.querySelectorAll('.unit-tab').forEach(button => {
       button.addEventListener('click', function() {
           const selectedUnit = this.getAttribute('data-unit-id');
           if (selectedUnit !== currentSelectedUnitId) {
               currentSelectedUnitId = selectedUnit;
               console.log(`Unit selected: ${currentSelectedUnitId}`);

               // Update active tab visual indicator
               document.querySelectorAll('.unit-tab').forEach(btn => btn.classList.remove('active-unit-tab'));
               this.classList.add('active-unit-tab');
               updatePageTitles()
               refreshUnitSpecificUI();

               // (Later: Call a function to refresh the UI for the selected unit)
           }
       });
   });

   // Set initial active tab style for Unit 1
   document.querySelector('.unit-tab[data-unit-id="1"]').classList.add('active-unit-tab');
            console.log('DOM fully loaded and parsed');
        });
        
        // Function to update current topic info in the Grok Prompt tab
        function updateCurrentTopicInfo() {
            const currentTopicInfo = document.getElementById('current-topic-info');
            if (!currentTopicInfo) return;
            
            // Find the current topic
            loadTopicProgress();
            
            // Check if all topics are completed
            const allCompleted = getSelectedUnitTopics().every(topic => {
                return topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed);
            });
            
            if (allCompleted) {
                // Update the section header
                const currentTopicHeader = document.getElementById('current-topic-header');
                if (currentTopicHeader) {
                    currentTopicHeader.textContent = '2. Congratulations!';
                }
                
                // Show completion message
                currentTopicInfo.innerHTML = `
                    <div class="text-center p-4">
                        <div class="text-green-500 text-5xl mb-4">ðŸŽ‰</div>
                        <h4 class="font-bold text-xl text-green-700 mb-2">All Topics Completed!</h4>
                        <p class="text-green-600 mb-4">Congratulations! You've completed all AP Statistics topics.</p>
                    </div>
                `;
                
                // Update the complete button to be a reset button
                const completeButton = document.getElementById('complete-current-topic-btn');
                if (completeButton) {
                    completeButton.className = "w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center justify-center";
                    completeButton.disabled = false;
                    completeButton.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                        </svg>
                        Reset Progress
                    `;
                    
                    // Remove any existing event listeners by cloning and replacing the button
                    const newButton = completeButton.cloneNode(true);
                    completeButton.parentNode.replaceChild(newButton, completeButton);
                    
                    // Add click event listener for reset with callback to refresh the UI
                    newButton.addEventListener('click', function() {
                        // Just call resetProgress once, which now handles all UI updates
                        resetProgress();
                    });
                }
                
                return;
            }
            
            const currentTopic = getSelectedUnitTopics().find(topic => topic.current) || getSelectedUnitTopics()[0];
            
            if (currentTopic) {
                // Check if this topic is completed
                const isCompleted = currentTopic.videos.every(v => v.completed) && 
                                   currentTopic.quizzes.every(q => q.completed);
                
                let statusBadge = '';
                if (isCompleted) {
                    statusBadge = '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Completed</span>';
                } else if (currentTopic.isCapstone) {
                    statusBadge = '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Capstone Challenge</span>';
                } else {
                    statusBadge = '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Current Focus</span>';
                }
                
                // Generate HTML for quiz links
                let quizLinksHTML = '';
                if (currentTopic.quizzes.length > 0) {
                    currentTopic.quizzes.forEach((quiz, index) => {
                        if (quiz.questionPdf) {
                            const questionTitle = currentTopic.isCapstone && currentTopic.quizzes.length > 1 
                                ? (quiz.quizId === "1-capstone_q1" ? "FRQ Questions" : quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : "MCQ Part B Answers")
                                : (currentTopic.isCapstone ? "FRQ Questions" : "Download Questions PDF");
                            
                            quizLinksHTML += `
                            <div class="flex items-center mb-2">
                                <input 
                                    type="checkbox" 
                                    id="current-quiz-${currentTopic.id}-${quiz.quizId}-questions" 
                                    class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                    ${quiz.completed ? 'checked' : ''} 
                                    data-topic-id="${currentTopic.id}" 
                                    data-item-type="quiz" 
                                    data-quiz-id="${quiz.quizId}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${quiz.questionPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                                    ${questionTitle}
                                </a>
                                <!-- Bookmark Button -->
                                <button
                                    class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                    title="Set as Bookmark"
                                    data-bookmark-unit="${currentSelectedUnitId}"
                                    data-bookmark-item="${currentTopic.id}-${quiz.quizId}-q"
                                    data-bookmark-type="quiz"
                                    data-bookmark-name="${currentTopic.name} - Questions PDF"
                                    data-bookmark-url="${quiz.questionPdf}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                    </svg>
                                </button>
                            </div>
                            `;
                        }
                        
                        if (quiz.answersPdf) {
                            const answerTitle = currentTopic.isCapstone ? 
                                (quiz.quizId === "1-capstone_q1" ? "FRQ Answers" : 
                                 quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : 
                                 "MCQ Part B Answers") : "Answers PDF";
                            quizLinksHTML += `
                            <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="current-quiz-${currentTopic.id}-${quiz.quizId}-answers" 
                                    class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                    ${quiz.completed ? 'checked' : ''} 
                                    data-topic-id="${currentTopic.id}" 
                                    data-item-type="quiz" 
                                    data-quiz-id="${quiz.quizId}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${quiz.answersPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                                    ${answerTitle}
                                </a>
                                <!-- Bookmark Button -->
                                <button
                                    class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                    title="Set as Bookmark"
                                    data-bookmark-unit="${currentSelectedUnitId}"
                                    data-bookmark-item="${currentTopic.id}-${quiz.quizId}-a"
                                    data-bookmark-type="quiz"
                                    data-bookmark-name="${currentTopic.name} - ${answerTitle}"
                                    data-bookmark-url="${quiz.answersPdf}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                            `;
                        }
                    });
                }
                
                // Generate HTML for video links
                let videoLinksHTML = '';
                if (currentTopic.videos.length > 0) {
                    currentTopic.videos.forEach((video, index) => {
                        const videoNumber = currentTopic.videos.length > 1 ? ` ${index + 1}` : '';
                        
                        if (video.url) {
                            videoLinksHTML += `
                            <div class="flex items-center mb-2">
                                <input 
                                    type="checkbox" 
                                    id="current-video-${currentTopic.id}-${index}" 
                                    class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                    ${video.completed ? 'checked' : ''} 
                                    data-topic-id="${currentTopic.id}" 
                                    data-item-type="video" 
                                    data-item-url="${video.url}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${video.url}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 group relative flex-grow">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                            </svg>
                                    Watch Topic Video${videoNumber}
                                    ${video.altUrl ? `
                            <span class="ml-1 text-xs bg-green-100 text-green-800 px-1 rounded flex-shrink-0">
                                <svg class="w-3 h-3 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </span>
                            <span class="absolute top-full left-0 mt-1 hidden group-hover:block bg-white border border-gray-200 rounded p-2 shadow-md text-xs text-gray-700 w-48 z-50">
                                        If AP Classroom is down, <a href="${video.altUrl}" class="text-blue-600 hover:text-blue-800">click here</a> for the backup Google Drive video.
                        </span>
                        ` : ''}
                        <!-- Bookmark Button -->
                        <button
                            class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                            title="Set as Bookmark"
                            data-bookmark-unit="${currentSelectedUnitId}"
                            data-bookmark-item="${currentTopic.id}-video-${index}"
                            data-bookmark-type="video"
                            data-bookmark-name="${currentTopic.name} - Video${videoNumber}"
                            data-bookmark-url="${video.url}"
                            data-bookmark-alt-url="${video.altUrl || ''}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                            </svg>
                        </button>
                    </a>
                            </div>
                            `;
                        } else if (video.altUrl) {
                            videoLinksHTML += `
                            <div class="flex items-center mb-2">
                                <input 
                                    type="checkbox" 
                                    id="current-video-${currentTopic.id}-${index}-alt" 
                                    class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                    ${video.completed ? 'checked' : ''} 
                                    data-topic-id="${currentTopic.id}" 
                                    data-item-type="video" 
                                    data-item-url="${video.altUrl}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${video.altUrl}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 flex-grow">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                                    Watch Topic Video${videoNumber} (Google Drive)
                                </a>
                                <!-- Bookmark Button -->
                                <button
                                    class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                    title="Set as Bookmark"
                                    data-bookmark-unit="${currentSelectedUnitId}"
                                    data-bookmark-item="${currentTopic.id}-video-${index}-alt"
                                    data-bookmark-type="video"
                                    data-bookmark-name="${currentTopic.name} - Video${videoNumber} (Google Drive)"
                                    data-bookmark-url="${video.altUrl}"
                                    data-bookmark-alt-url="${video.url || ''}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                    </svg>
                                </button>
                            </div>
                            `;
                        }
                    });
                }
                
                currentTopicInfo.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-lg">${currentTopic.name}</h4>
                        ${statusBadge}
                    </div>
                    <p class="text-gray-700 mb-3">${currentTopic.description}</p>
                    <div class="flex flex-col gap-2">
                        ${quizLinksHTML}
                        ${!quizLinksHTML && currentTopic.quizzes.length === 0 ? `
                        <div class="p-2 bg-blue-50 rounded text-blue-700 text-sm mb-2">
                            <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            This topic has video content only (no practice PDFs)
                        </div>
                            ` : ''}
                        ${videoLinksHTML}
                    </div>
                `;
            } else {
                currentTopicInfo.innerHTML = '<p class="text-red-500">No current topic found. Please go to Study Materials and select a topic.</p>';
            }
            
            // Update the complete button to handle the current topic
            const completeButton = document.getElementById('complete-current-topic-btn');
            if (completeButton && currentTopic) {
                // Check if this topic is completed (all videos and quizzes completed)
                const isCompleted = currentTopic.videos.every(v => v.completed) && 
                                   currentTopic.quizzes.every(q => q.completed);
                
                // Enable or disable button based on topic status
                if (isCompleted) {
                    completeButton.classList.add('bg-gray-400');
                    completeButton.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                    completeButton.disabled = true;
                    completeButton.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Topic Already Completed
                    `;
                } else {
                    completeButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
                    completeButton.classList.remove('bg-gray-400');
                    completeButton.disabled = false;
                    completeButton.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Mark Current Topic as Completed
                    `;
                }
                
                // Remove any existing event listeners by cloning and replacing the button
                const newButton = completeButton.cloneNode(true);
                completeButton.parentNode.replaceChild(newButton, completeButton);
                
                // Add click event listener with current topic ID
                newButton.addEventListener('click', function() {
                    if (!isCompleted) {
                        markTopicAsCompleted(currentTopic.id);
                        
                        // Update both the current topic info and quick access cards
                        updateCurrentTopicInfo();
                        populateQuickAccessTopics();
                    }
                });
            }
        }
        
        // Function to populate quick access topic cards in the Grok Prompt tab
        function populateQuickAccessTopics() {
            const container = document.getElementById('quick-access-topics');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Check if all topics are completed
            const allCompleted = getSelectedUnitTopics().every(topic => {
                return topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed);
            });
            
            if (allCompleted) {
                // Set a special header for completed state
                container.innerHTML = `
                    <div class="col-span-2 text-center mb-2">
                        <div class="bg-green-100 text-green-800 text-sm py-2 px-4 rounded-full inline-block">
                            <span class="mr-1">âœ“</span> All Topics Completed
                        </div>
                    </div>
                `;
                
                // Add the capstone challenge at the top
                const capstoneTopic = getSelectedUnitTopics().find(topic => topic.isCapstone);
                if (capstoneTopic) {
                    const capstoneCard = document.createElement('div');
                    capstoneCard.className = 'col-span-2 p-4 rounded-lg shadow-md bg-red-50 border border-red-200 capstone-highlight';
                    
                    // Generate HTML for the capstone quiz links with checkboxes
                    let capstoneQuizLinksHTML = '';
                    capstoneTopic.quizzes.forEach((quiz, index) => {
                        if (quiz.questionPdf) {
                            const title = quiz.quizId === "1-capstone_q1" ? "FRQ Questions" : 
                                          quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : "MCQ Part B Answers";
                            
                            capstoneQuizLinksHTML += `
                            <div class="flex items-center mb-2">
                                <input 
                                    type="checkbox" 
                                    id="qa-quiz-${capstoneTopic.id}-${quiz.quizId}-questions" 
                                    class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                    ${quiz.completed ? 'checked' : ''} 
                                    data-topic-id="${capstoneTopic.id}" 
                                    data-item-type="quiz" 
                                    data-quiz-id="${quiz.quizId}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${quiz.questionPdf}" target="_blank" download class="text-blue-600 hover:text-blue-800 text-sm bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                        ${title}
                                </span>
                            </a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${capstoneTopic.id}-${quiz.quizId}-q"
                                data-bookmark-type="quiz"
                                data-bookmark-name="${capstoneTopic.name} - Questions PDF"
                                data-bookmark-url="${quiz.questionPdf}">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                            </div>
                            `;
                        }
                        
                        if (quiz.answersPdf) {
                            const answerTitle = quiz.quizId === "1-capstone_q1" ? "FRQ Answers" : 
                                               quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : 
                                               "MCQ Part B Answers";
                            capstoneQuizLinksHTML += `
                            <div class="flex items-center mb-2">
                                <input 
                                    type="checkbox" 
                                    id="qa-quiz-${capstoneTopic.id}-${quiz.quizId}-answers" 
                                    class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                    ${quiz.completed ? 'checked' : ''} 
                                    data-topic-id="${capstoneTopic.id}" 
                                    data-item-type="quiz" 
                                    data-quiz-id="${quiz.quizId}"
                                    onchange="handleItemCompletionChange(event)"
                                >
                                <a href="${quiz.answersPdf}" target="_blank" download class="text-blue-600 hover:text-blue-800 text-sm bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    ${answerTitle}
                                </span>
                            </a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${capstoneTopic.id}-${quiz.quizId}-a"
                                data-bookmark-type="quiz"
                                data-bookmark-name="${capstoneTopic.name} - ${answerTitle}"
                                data-bookmark-url="${quiz.answersPdf}">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                            </div>
                            `;
                        }
                    });
                    
                    capstoneCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-lg"><span class="text-red-500 mr-1">ðŸ†</span>${capstoneTopic.name}</h4>
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Completed</span>
                        </div>
                        <p class="text-gray-700 mb-3">${capstoneTopic.description}</p>
                        <div class="flex flex-col gap-2">
                            ${capstoneQuizLinksHTML}
                        </div>
                    `;
                    
                    container.appendChild(capstoneCard);
                }
            }
            
            // If not all completed or even after showing completed state, add the topic cards
            getSelectedUnitTopics().forEach(topic => {
                // If all completed and this is the capstone, skip (we already added it above)
                if (allCompleted && topic.isCapstone) return;
                
                // Check if this topic is completed
                const isCompleted = topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed);
                
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg shadow-sm border ${isCompleted ? 'bg-green-50 border-green-200' : topic.isCapstone ? 'bg-red-50 border-red-200' : topic.current ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200'} cursor-pointer hover:shadow-md transition-shadow`;
                
                let statusIcon = '';
                if (isCompleted) {
                    statusIcon = '<span class="text-green-500 mr-1">âœ“</span>';
                } else if (topic.current) {
                    statusIcon = '<span class="text-blue-500 mr-1">â†’</span>';
                } else if (topic.isCapstone) {
                    statusIcon = '<span class="text-red-500 mr-1">ðŸ†</span>';
                }
                
                // Generate links HTML for the compact card with checkboxes
                let linksHTML = '';
                
                // Add quiz links with checkboxes
                topic.quizzes.forEach((quiz, index) => {
                    if (quiz.questionPdf) {
                        const linkText = topic.isCapstone && topic.quizzes.length > 1
                            ? (quiz.quizId === "1-capstone_q1" ? "FRQ Questions" : quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : "MCQ Part B Answers")
                            : (topic.isCapstone ? "FRQ Questions" : "Questions PDF");
                        
                        linksHTML += `
                        <div class="flex items-center mb-1">
                            <input 
                                type="checkbox" 
                                id="qa-menu-quiz-${topic.id}-${quiz.quizId}-questions" 
                                class="mr-1 h-3 w-3 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                ${quiz.completed ? 'checked' : ''} 
                                data-topic-id="${topic.id}" 
                                data-item-type="quiz" 
                                data-quiz-id="${quiz.quizId}"
                                onchange="handleItemCompletionChange(event)"
                            >
                            <a href="${quiz.questionPdf}" target="_blank" download class="text-blue-600 hover:text-blue-800 text-xs">${linkText}</a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-1 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${topic.id}-${quiz.quizId}-q"
                                data-bookmark-type="quiz"
                                data-bookmark-name="${topic.name} - ${linkText}"
                                data-bookmark-url="${quiz.questionPdf}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                        </div>`;
                    }
                    
                    if (quiz.answersPdf) {
                        const answerTitle = topic.isCapstone ? 
                            (quiz.quizId === "1-capstone_q1" ? "FRQ Answers" : 
                             quiz.quizId === "1-capstone_q2" ? "MCQ Part A Answers" : 
                             "MCQ Part B Answers") : "Answers PDF";
                        linksHTML += `
                        <div class="flex items-center mb-1">
                            <input 
                                type="checkbox" 
                                id="qa-menu-quiz-${topic.id}-${quiz.quizId}-answers" 
                                class="mr-1 h-3 w-3 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                ${quiz.completed ? 'checked' : ''} 
                                data-topic-id="${topic.id}" 
                                data-item-type="quiz" 
                                data-quiz-id="${quiz.quizId}"
                                onchange="handleItemCompletionChange(event)"
                            >
                            <a href="${quiz.answersPdf}" target="_blank" download class="text-blue-600 hover:text-blue-800 text-xs">${answerTitle}</a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-1 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${topic.id}-${quiz.quizId}-a"
                                data-bookmark-type="quiz"
                                data-bookmark-name="${topic.name} - ${answerTitle}"
                                data-bookmark-url="${quiz.answersPdf}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                        </div>`;
                    }
                });
                
                // Add a note if no quiz PDFs are available
                if (topic.quizzes.length === 0) {
                    linksHTML += `<span class="text-blue-500 italic text-xs">Video content only</span>`;
                }
                
                // Add video links with checkboxes
                topic.videos.forEach((video, index) => {
                    const videoNumber = topic.videos.length > 1 ? ` ${index + 1}` : '';
                    
                    if (video.url) {
                        linksHTML += `
                        <div class="flex items-center mb-1">
                            <input 
                                type="checkbox" 
                                id="qa-menu-video-${topic.id}-${index}" 
                                class="mr-1 h-3 w-3 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                ${video.completed ? 'checked' : ''} 
                                data-topic-id="${topic.id}" 
                                data-item-type="video" 
                                data-item-url="${video.url}"
                                onchange="handleItemCompletionChange(event)"
                            >
                            <a href="${video.url}" target="_blank" class="text-yellow-600 hover:text-yellow-800 text-xs">Video${videoNumber} ${video.altUrl ? '(+)' : ''}</a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-1 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${topic.id}-video-${index}"
                                data-bookmark-type="video"
                                data-bookmark-name="${topic.name} - Video${videoNumber}"
                                data-bookmark-url="${video.url}"
                                data-bookmark-alt-url="${video.altUrl || ''}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                        </div>`;
                    } else if (video.altUrl) {
                        linksHTML += `
                        <div class="flex items-center mb-1">
                            <input 
                                type="checkbox" 
                                id="qa-menu-video-${topic.id}-${index}-alt" 
                                class="mr-1 h-3 w-3 text-yellow-600 focus:ring-yellow-500 cursor-pointer" 
                                ${video.completed ? 'checked' : ''} 
                                data-topic-id="${topic.id}" 
                                data-item-type="video" 
                                data-item-url="${video.altUrl}"
                                onchange="handleItemCompletionChange(event)"
                            >
                            <a href="${video.altUrl}" target="_blank" class="text-yellow-600 hover:text-yellow-800 text-xs">Video${videoNumber}</a>
                            <!-- Bookmark Button -->
                            <button
                                class="p-1 ml-1 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0"
                                title="Set as Bookmark"
                                data-bookmark-unit="${currentSelectedUnitId}"
                                data-bookmark-item="${topic.id}-video-${index}-alt"
                                data-bookmark-type="video"
                                data-bookmark-name="${topic.name} - Video${videoNumber} (Drive)"
                                data-bookmark-url="${video.altUrl}"
                                data-bookmark-alt-url="${video.url || ''}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>
                                </svg>
                            </button>
                        </div>`;
                    }
                });
                
                card.innerHTML = `
                    <div class="font-medium mb-2">${statusIcon}${topic.name}</div>
                    <div class="flex flex-col gap-1">
                        ${linksHTML}
                    </div>
                `;
                
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking on a link or checkbox
                    if (e.target.tagName === 'A' || e.target.tagName === 'INPUT') return;
                    
                    // Set this topic as current
                    getSelectedUnitTopics().forEach(t => t.current = false);
                    topic.current = true;
                    saveTopicProgress();
                    
                    // Update UI
                    updateCurrentTopicInfo();
                    populateQuickAccessTopics();
                });
                
                container.appendChild(card);
            });
            
            // If all completed, update the title
            if (allCompleted) {
                const topicsHeader = document.querySelector('.grok-prompt-topics-header');
                if (topicsHeader) {
                    topicsHeader.textContent = 'Topic Review';
                }
            }
        }
        
        // Function to set a topic as current
        function setTopicAsCurrent(topicName) {
            getSelectedUnitTopics().forEach(topic => {
                topic.current = (topic.name === topicName);
            });
            saveTopicProgress();
            updateCurrentTopicInfo();
            populateQuickAccessTopics();
            updateAllBookmarkButtons();
        }
        
        // Function to handle completion change for individual items
        function handleItemCompletionChange(event) {
            const checkbox = event.target;
            const dataset = checkbox.dataset;
            const isCompleted = checkbox.checked;
            
            // Extract data from dataset
            const topicId = dataset.topicId;
            const itemType = dataset.itemType;
            
            if (itemType === 'video') {
                // For videos, we use the item URL to identify them
                const videoUrl = dataset.itemUrl;
                markVideoComplete(topicId, videoUrl, isCompleted);
            } else if (itemType === 'quiz') {
                // For quizzes, we use the quiz ID to identify them
                const quizId = dataset.quizId;
                markQuizComplete(topicId, quizId, isCompleted);
            }
        }
        
        // Make the topic functions available globally
        window.markTopicAsCompleted = markTopicAsCompleted;
        window.markVideoComplete = markVideoComplete;
        window.markQuizComplete = markQuizComplete;
        window.handleItemCompletionChange = handleItemCompletionChange;
        
        // Listen for browser coming back online
        window.addEventListener('online', function() {
            console.log("Browser detected online status.");
            
            if (currentUserId) {
                syncOfflineQueue();
            } else {
                console.log("User not identified, cannot sync yet.");
            }
        });
        
        // Initialize overall progress tab if that tab is initially selected
        if (document.getElementById('tab-overall-progress').classList.contains('active')) {
            displayOverallProgress();
        }
        
        // Function to display overall progress information
        async function displayOverallProgress() {
            try {
                // Show loading message and hide/clear other content initially
                const loadingEl = document.getElementById('overall-progress-loading');
                loadingEl.style.display = 'block';
                
                // Clear/hide other container contents
                document.getElementById('dot-plot-container').innerHTML = '';
                document.getElementById('remaining-items').innerHTML = '';
                document.getElementById('flexible-quota').innerHTML = '';
                document.getElementById('todays-quota-status').innerHTML = '';
                document.getElementById('peer-quota-table').innerHTML = '';
                document.getElementById('peer-quota-loading').style.display = 'none';
                
                // Call functions to populate different sections
                await displaySupabaseDotPlot();
                displayRemainingItemCounts();
                displayFlexibleQuota();
                await displayDailyQuotaStatus();
                await fetchAndDisplayPeerQuotas();
            } finally {
                // Hide loading message after all operations complete (even if there was an error)
                document.getElementById('overall-progress-loading').style.display = 'none';
            }
        }
        
        // Function to display total remaining item counts
        function displayRemainingItemCounts() {
            const targetEl = document.getElementById('remaining-items');
            
            // Check if ALL_UNITS_DATA exists
            if (typeof ALL_UNITS_DATA === 'undefined' || !Array.isArray(ALL_UNITS_DATA)) {
                targetEl.innerHTML = `<div class="text-red-500">Error: Course data not loaded properly. Please refresh the page.</div>`;
                return;
            }
            
            // Get total counts using the function from allUnitsData.js
            const { totalVideos, totalQuizzes } = getTotalItemCounts(ALL_UNITS_DATA);
            
            // Display the information
            targetEl.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-800">Course Content Overview</h3>
                <p>Total Items Across All Units: ${totalVideos} videos, ${totalQuizzes} quizzes.</p>
            `;
        }
        
        // Function to display flexible quota information based on AP exam deadline
        async function displayFlexibleQuota() {
            const targetEl = document.getElementById('flexible-quota');
            targetEl.innerHTML = `<p class="text-gray-500">Calculating dynamic goal...</p>`; // Loading message

            const { requiredVideosPerDay, requiredQuizzesPerDay, daysRemaining, error } = await calculateDynamicQuota();

            if (error) {
                 targetEl.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2 text-indigo-800">Flexible Daily Goal</h3>
                    <p class="text-red-500">Could not calculate dynamic goal: ${error}. Using defaults.</p>
                    <p class="font-medium mt-1">~5 videos & ~3 quizzes per day (Default)</p>
                 `;
                 return;
            }

            if (daysRemaining <= 0) {
                 targetEl.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2 text-indigo-800">Flexible Daily Goal</h3>
                    <p>The AP Exam date (May 8th, 2025) has passed or is today.</p>
                    ${ (requiredVideosPerDay > 0 || requiredQuizzesPerDay > 0)
                        ? `<p class="font-medium mt-1">Remaining: ${requiredVideosPerDay} videos & ${requiredQuizzesPerDay} quizzes.</p>`
                        : '<p class="font-medium mt-1 text-green-600">All course items completed!</p>'
                    }
                `;
                 return;
            }

            // Display the dynamically calculated information
            targetEl.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-800">Flexible Daily Goal (Dynamic)</h3>
                <p>To complete remaining content by the AP Exam (May 8th, 2025):</p>
                <p class="font-medium mt-1">~${requiredVideosPerDay} videos & ~${requiredQuizzesPerDay} quizzes per day</p>
                <p class="text-sm text-gray-500 mt-1">${daysRemaining} days remaining until the exam</p>
            `;
        }
        
        // Function to display a dot plot visualization of completions from Supabase
        async function displaySupabaseDotPlot() {
            const container = document.getElementById('dot-plot-container');

            // Check if user is identified
            if (!currentUserId) {
                container.innerHTML = `
                    <div class="text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700">Please enter username to view overall progress.</p>
                    </div>
                `;
                return;
            }

            // Clear previous content and show loading message
            container.innerHTML = `
                <div class="text-center p-4">
                    <p class="text-gray-500">Loading dot plot data...</p>
                </div>
            `;

            try {
                // Fetch completed_at AND item_type timestamps from Supabase
                const { data, error } = await supabaseClient
                    .from('completions')
                    .select('completed_at, item_type') // <-- Fetch item_type too
                    .eq('user_id', currentUserId)
                    .order('completed_at');

                console.log('DEBUG (DotPlot): Fetched data from Supabase completions:', data);

                if (error) {
                    console.log('DEBUG (DotPlot): Fetch returned an error.');
                    throw new Error(`Error fetching completion data: ${error.message}`);
                }

                if (!data || data.length === 0) {
                    console.log('DEBUG (DotPlot): No data found or data array is empty.');
                    container.innerHTML = `
                        <div class="text-center p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-blue-700">No completions found. Start completing topics to see your progress!</p>
                        </div>
                    `;
                    return;
                }

                console.log('DEBUG (DotPlot): Proceeding to process fetched data...');

                // Convert completion data to objects with Date and type, filter invalid dates
                const completionItems = data
                    .map(item => ({ date: new Date(item.completed_at), type: item.item_type }))
                    .filter(item => !isNaN(item.date));

                if (completionItems.length === 0) {
                     container.innerHTML = `
                        <div class="text-center p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-blue-700">No valid completion dates found.</p>
                        </div>
                    `;
                    return;
                }

                // Find the minimum and maximum dates from valid items
                const minDate = new Date(Math.min(...completionItems.map(item => item.date.getTime())));
                const maxDate = new Date(Math.max(...completionItems.map(item => item.date.getTime())));

                console.log('DEBUG (DotPlot): Date Range:', minDate, 'to', maxDate);

                // Define constants for time durations in milliseconds
                const MSEC_PER_HOUR = 60 * 60 * 1000;
                const MSEC_PER_DAY = 24 * MSEC_PER_HOUR;
                const MSEC_PER_WEEK = 7 * MSEC_PER_DAY;
                const MSEC_PER_MONTH = 30 * MSEC_PER_DAY; // Approximation

                // Calculate the total duration
                const totalDuration = maxDate.getTime() - minDate.getTime();

                // Determine time unit and bin duration (same logic as before)
                let timeUnit = 'days';
                let binDurationMillis = MSEC_PER_DAY;
                 if (totalDuration <= MSEC_PER_HOUR) {
                    timeUnit = 'hours';
                    binDurationMillis = MSEC_PER_HOUR;
                    const midPoint = (minDate.getTime() + maxDate.getTime()) / 2;
                    minDate.setTime(midPoint - 2 * MSEC_PER_HOUR);
                    maxDate.setTime(minDate.getTime() + 5 * MSEC_PER_HOUR);
                } else if (totalDuration <= 12 * MSEC_PER_HOUR) {
                    timeUnit = 'hours';
                    binDurationMillis = Math.max(MSEC_PER_HOUR, totalDuration / 5);
                } else if (totalDuration <= 10 * MSEC_PER_DAY) {
                    timeUnit = 'days';
                    binDurationMillis = Math.max(MSEC_PER_DAY, totalDuration / 5);
                } else if (totalDuration <= 10 * MSEC_PER_WEEK) {
                    timeUnit = 'weeks';
                    binDurationMillis = Math.max(MSEC_PER_WEEK, totalDuration / 5);
                } else {
                    timeUnit = 'months';
                    binDurationMillis = Math.max(MSEC_PER_MONTH, totalDuration / 5);
                }
                // ... (logging logic for unit/duration remains the same) ...
                 if (timeUnit === 'hours') {
                    console.log(`DEBUG (DotPlot): Using ${timeUnit} bins, duration approx ${Math.round(binDurationMillis / MSEC_PER_HOUR * 10)/10} ${timeUnit}`);
                } else if (timeUnit === 'days') {
                    console.log(`DEBUG (DotPlot): Using ${timeUnit} bins, duration approx ${Math.round(binDurationMillis / MSEC_PER_DAY * 10)/10} ${timeUnit}`);
                } else if (timeUnit === 'weeks') {
                    console.log(`DEBUG (DotPlot): Using ${timeUnit} bins, duration approx ${Math.round(binDurationMillis / MSEC_PER_WEEK * 10)/10} ${timeUnit}`);
                } else {
                    console.log(`DEBUG (DotPlot): Using ${timeUnit} bins, duration approx ${Math.round(binDurationMillis / MSEC_PER_MONTH * 10)/10} ${timeUnit}`);
                }


                // Define bin boundaries and initialize counts for videos and quizzes
                let binStart = minDate.getTime();
                const binBoundaries = [];
                // Initialize counts per bin for each type
                const binData = Array(5).fill(null).map(() => ({ video: 0, quiz: 0 }));

                 // Create 5 equally-sized bins
                for (let i = 0; i < 5; i++) {
                    const currentBinEnd = binStart + binDurationMillis;
                    binBoundaries.push({ start: binStart, end: currentBinEnd });
                    binStart = currentBinEnd;
                }
                 // Ensure the last bin includes the maxDate
                if (binBoundaries.length > 0 && binBoundaries[binBoundaries.length - 1].end < maxDate.getTime()) {
                    binBoundaries[binBoundaries.length - 1].end = maxDate.getTime() + 1; // Add 1ms to ensure inclusion
                }

                console.log('DEBUG (DotPlot): Bin Boundaries:', binBoundaries);

                // Assign completions to bins based on type
                completionItems.forEach(item => {
                    const time = item.date.getTime();
                    for (let j = 0; j < 5; j++) {
                        const { start, end } = binBoundaries[j];
                        if (time >= start && time < end) { // End is exclusive except for last bin handled implicitly
                            if (item.type === 'video') {
                                binData[j].video++;
                            } else if (item.type === 'quiz') {
                                binData[j].quiz++;
                            }
                            break; // Item assigned to a bin
                        }
                    }
                     // Check last bin inclusivity specifically
                     if(time >= binBoundaries[4].start && time <= binBoundaries[4].end) {
                         // This logic might double count if the loop above didn't break correctly,
                         // but ensures items exactly at the end are caught IF the loop above misses them.
                         // A cleaner way is to ensure the loop handles the last bin correctly.
                         // Let's refine the loop instead.
                     }
                });


                console.log('DEBUG (DotPlot): Bin Data (Video/Quiz):', binData);

                // Helper function to format bin labels (same as before)
                function formatBinLabel(startDate, endDate, timeUnit) {
                    const start = new Date(startDate);
                    // For display, make the end date slightly less than the actual boundary
                    const displayEnd = new Date(endDate - 1); 

                    if (timeUnit === 'hours') {
                        const startMonth = start.toLocaleString('en-US', { month: 'short' });
                        const startDay = start.getDate();
                        const startHour = start.getHours();
                        // Use displayEnd for the end hour
                        const endHour = displayEnd.getHours(); 

                        const formatHour = (hour) => {
                            if (hour === 0) return '12am';
                            if (hour === 12) return '12pm';
                            return hour < 12 ? `${hour}am` : `${hour - 12}pm`;
                        };
                        
                        // Handle case where end hour wraps around midnight or noon incorrectly
                        const endHourFormatted = formatHour(endHour);
                        // If start and end hour are the same after formatting, maybe show just one? Or show next hour?
                        // Let's show the range for clarity
                        const startHourFormatted = formatHour(startHour);

                        return `${startMonth} ${startDay}, ${startHourFormatted}-${formatHour(startHour + 1)}`; // Show 1hr block label
                    } else if (timeUnit === 'days') {
                        const startMonth = start.toLocaleString('en-US', { month: 'short' });
                        const startDay = start.getDate();
                        const endMonth = displayEnd.toLocaleString('en-US', { month: 'short' });
                        const endDay = displayEnd.getDate();

                        if (startMonth === endMonth && startDay === endDay) {
                            return `${startMonth} ${startDay}`;
                        } else if (startMonth === endMonth) {
                            return `${startMonth} ${startDay}-${endDay}`;
                        } else {
                            return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
                        }
                    } else if (timeUnit === 'weeks') {
                         const startMonth = start.toLocaleString('en-US', { month: 'short' });
                        const startDay = start.getDate();
                        return `Week of ${startMonth} ${startDay}`;
                    } else { // months
                        const startMonth = start.toLocaleString('en-US', { month: 'short' });
                        const startYear = start.getFullYear();
                        return `${startMonth} ${startYear}`;
                    }
                }

                // Initialize the HTML for the dot plot
                let dotPlotHtml = `
                    <h3 class="text-lg font-semibold mb-3 text-indigo-800">Overall Completions Logged Online</h3>
                    <div class="flex justify-center items-center space-x-4 mt-2 mb-4 text-sm text-gray-500">
                        <span><span class="inline-block w-3 h-3 bg-blue-600 rounded-full mr-1"></span>Video</span>
                        <span><span class="inline-block w-3 h-3 bg-green-600 rounded-full mr-1"></span>Quiz</span>
                    </div>
                    <div class="space-y-2 p-2 bg-gray-50 rounded-lg">
                `;

                // Generate the HTML for each bin, now with colored dots
                for (let i = 0; i < 5; i++) {
                    const videoCount = binData[i].video;
                    const quizCount = binData[i].quiz;
                    const totalBinCount = videoCount + quizCount;
                    const startDate = binBoundaries[i].start;
                    const endDate = binBoundaries[i].end;
                    const binLabel = formatBinLabel(startDate, endDate, timeUnit);

                    // Generate the dots (blue for video, green for quiz)
                    let dots = '';
                    for (let j = 0; j < videoCount; j++) {
                        dots += `<span class="inline-block w-3 h-3 bg-blue-600 rounded-full mx-0.5"></span>`; // Use blue-600
                    }
                    for (let k = 0; k < quizCount; k++) {
                        dots += `<span class="inline-block w-3 h-3 bg-green-600 rounded-full mx-0.5"></span>`; // Use green-600
                    }

                    // Add the bin to the HTML
                    dotPlotHtml += `
                        <div class="flex items-center">
                            <div class="w-32 font-medium text-gray-700 text-sm truncate pr-2">${binLabel}</div>
                            <div class="flex-1 flex flex-wrap items-center">${dots || '<span class="text-gray-400 text-xs"></span>'}</div>
                            <div class="w-8 text-right text-gray-600">${totalBinCount}</div>
                        </div>
                    `;
                }

                // Close the main div
                dotPlotHtml += `</div>`;

                // Calculate and add summary statistics (using total length of valid items)
                const totalCompletions = completionItems.length;
                 const formattedStartDate = minDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedEndDate = maxDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                // Calculate number of active days
                const activeDaysSet = new Set();
                completionItems.forEach(item => {
                    const dateStr = item.date.toISOString().split('T')[0];
                    activeDaysSet.add(dateStr);
                });
                const activeDays = activeDaysSet.size;
                const averagePerDay = activeDays > 0 ? Math.round((totalCompletions / activeDays) * 10) / 10 : 0;

                // Add summary statistics to the HTML
                dotPlotHtml += `
                    <div class="mt-3 grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 bg-gray-50 rounded-lg">
                            <div class="text-xl font-bold text-indigo-600">${totalCompletions}</div>
                            <div class="text-xs text-gray-500">Total Completions</div>
                        </div>
                        <div class="p-2 bg-gray-50 rounded-lg">
                            <div class="text-xl font-bold text-indigo-600">${activeDays}</div>
                            <div class="text-xs text-gray-500">Active Days</div>
                        </div>
                        <div class="p-2 bg-gray-50 rounded-lg">
                            <div class="text-xl font-bold text-indigo-600">${averagePerDay}</div>
                            <div class="text-xs text-gray-500">Avg Per Active Day</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 text-center">
                        Data from ${formattedStartDate} to ${formattedEndDate}
                    </div>
                `;

                console.log('DEBUG (DotPlot): Generated dotPlotHtml. Length:', dotPlotHtml ? dotPlotHtml.length : 'null');
                
                // Assign the HTML to the container
                container.innerHTML = dotPlotHtml;
                
                console.log("DEBUG (DotPlot): Assigned HTML to container.");
            } catch (err) {
                console.log('DEBUG (DotPlot): Caught error during processing/rendering.');
                container.innerHTML = `
                    <div class="text-center p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-700">Error fetching dot plot data: ${err.message || 'Unknown error'}</p>
                    </div>
                `;
            }
        }
        
        // Function to display today's quota status
        function displayTodaysQuotaStatus() {
            const container = document.getElementById('todays-quota-status');
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Check localStorage for quota status
            const quotaMetKey = `quotaMet_${dateStr}`;
            const quotaMetStatus = localStorage.getItem(quotaMetKey);
            
            // Default quota goals
            const defaultVideoGoal = 5;
            const defaultQuizGoal = 3;
            
            // Create the status message
            let statusHtml = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-800">Today's Local ${defaultVideoGoal}/${defaultQuizGoal} Goal</h3>
            `;
            
            if (quotaMetStatus === 'true') {
                statusHtml += `
                    <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                        <svg class="w-6 h-6 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="font-medium text-green-700">Met! Well done!</p>
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="font-medium text-yellow-700">Not yet met. Keep going!</p>
                    </div>
                `;
            }
            
            // Add explanation
            statusHtml += `
                <p class="mt-2 text-sm text-gray-500">
                    This status is saved locally in your browser. Complete ${defaultVideoGoal} videos and ${defaultQuizGoal} quizzes today to meet your goal.
                </p>
            `;
            
            container.innerHTML = statusHtml;
        }
        
        // Function to calculate the dynamic flexible daily quota
        async function calculateDynamicQuota() {
            const defaultQuota = { requiredVideosPerDay: 0, requiredQuizzesPerDay: 0, daysRemaining: 0, error: null };

            if (!currentUserId) {
                console.warn("DynamicQuota: Cannot calculate without user ID.");
                return { ...defaultQuota, error: "No user ID" };
            }
            // Ensure ALL_UNITS_DATA is loaded and is an array
            if (typeof ALL_UNITS_DATA === 'undefined' || !Array.isArray(ALL_UNITS_DATA)) {
                console.error("DynamicQuota: ALL_UNITS_DATA not available or not an array.");
                return { ...defaultQuota, error: "Course data not loaded" };
            }

            try {
                // --- Get Total Items ---
                // Use getTotalItemCounts ONLY for totals, not completions
                const { totalVideos, totalQuizzes } = getTotalItemCounts(ALL_UNITS_DATA);
                console.log(`DynamicQuota: Total items from definition: ${totalVideos} videos, ${totalQuizzes} quizzes.`);


                // --- Get Completed Items from Supabase ---
                console.log(`DynamicQuota: Fetching completions for user ${currentUserId}`);
                const { data: completionsData, error: completionsError } = await supabaseClient
                    .from('completions')
                    .select('item_type') // Select only item_type, no need for count here
                    .eq('user_id', currentUserId);

                if (completionsError) {
                    console.error("DynamicQuota: Error fetching completions:", completionsError);
                    // Return default but indicate error, allows rest of UI to potentially load
                    return { ...defaultQuota, error: `Failed to fetch completions: ${completionsError.message}` };
                }

                // Calculate completed counts from the fetched Supabase data
                const completedVideos = completionsData?.filter(item => item.item_type === 'video').length || 0;
                const completedQuizzes = completionsData?.filter(item => item.item_type === 'quiz').length || 0;
                console.log(`DynamicQuota: User has completed (from Supabase): ${completedVideos} videos, ${completedQuizzes} quizzes.`);

                // --- Calculate Remaining Items ---
                const remainingVideos = Math.max(0, totalVideos - completedVideos);
                const remainingQuizzes = Math.max(0, totalQuizzes - completedQuizzes);
                console.log(`DynamicQuota: Remaining items: ${remainingVideos} videos, ${remainingQuizzes} quizzes.`);

                // --- Calculate Days Remaining ---
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set time to 00:00:00 for accurate date comparison
                // Use ISO format for reliability
                const examDate = new Date('2025-05-08T00:00:00Z'); // May 8th, 2025 UTC
                console.log(`DynamicQuota: Today (start of day): ${today.toISOString()}, Exam Date: ${examDate.toISOString()}`);


                if (today >= examDate) {
                    console.log("DynamicQuota: Exam date has passed or is today.");
                    return {
                        requiredVideosPerDay: remainingVideos > 0 ? remainingVideos : 0,
                        requiredQuizzesPerDay: remainingQuizzes > 0 ? remainingQuizzes : 0,
                        daysRemaining: 0,
                        error: null
                    };
                }

                const timeDiff = examDate.getTime() - today.getTime();
                // Use floor division for days remaining, ensuring we count full days
                const daysRemaining = Math.max(1, Math.floor(timeDiff / (1000 * 3600 * 24))); // Ensure at least 1 day if not passed
                console.log(`DynamicQuota: Days remaining until exam: ${daysRemaining}`);


                // --- Calculate Dynamic Quota ---
                // Use remaining days for calculation
                const requiredVideosPerDay = Math.ceil(remainingVideos / daysRemaining);
                const requiredQuizzesPerDay = Math.ceil(remainingQuizzes / daysRemaining);


                console.log(`DynamicQuota: Calculated quota -> Videos/day: ${requiredVideosPerDay}, Quizzes/day: ${requiredQuizzesPerDay}`);

                return {
                    requiredVideosPerDay: requiredVideosPerDay,
                    requiredQuizzesPerDay: requiredQuizzesPerDay,
                    daysRemaining: daysRemaining,
                    error: null // Indicate success
                };

            } catch (error) {
                console.error("DynamicQuota: Exception during calculation:", error);
                return { ...defaultQuota, error: `Exception: ${error.message}` };
            }
        }
        
        // Function to display daily quota status from Supabase
        async function displayDailyQuotaStatus() {
            const container = document.getElementById('todays-quota-status');
            console.log(`DEBUG (QuotaDisplay - Entry): Function called. currentUserId is: ${currentUserId} (Type: ${typeof currentUserId})`);

            if (!currentUserId) {
                container.innerHTML = `
                    <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <p class="text-gray-700">Enter username to see quota status.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<p class="text-gray-500">Loading today's goal status...</p>`; // Loading state

            try {
                // --- 1. Get Dynamic Quota Targets ---
                console.log('DEBUG (QuotaDisplay): Calculating dynamic quota targets...');
                const { requiredVideosPerDay, requiredQuizzesPerDay, error: quotaError } = await calculateDynamicQuota();

                if (quotaError) {
                    console.error(`DEBUG (QuotaDisplay): Failed to calculate dynamic quota: ${quotaError}.`);
                    container.innerHTML = `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p class="text-red-700">Could not calculate dynamic goal: ${quotaError}. Please try again later.</p>
                        </div>
                    `;
                    return;
                }
                console.log(`DEBUG (QuotaDisplay): Dynamic targets: Videos=${requiredVideosPerDay}, Quizzes=${requiredQuizzesPerDay}`);

                // --- 2. Get Today's Completions (Best Effort) ---
                let videosToday = 0;
                let quizzesToday = 0;
                const now = new Date();
                const startOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0, 0));
                const endOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999));

                try {
                    const { data: completionsData, error: completionsError } = await supabaseClient
                        .from('completions')
                        .select('item_type')
                        .eq('user_id', currentUserId)
                        .gte('completed_at', startOfDayUTC.toISOString())
                        .lte('completed_at', endOfDayUTC.toISOString());

                    if (completionsError) {
                        console.warn("DEBUG (QuotaDisplay): Error fetching today's completions for display:", completionsError.message);
                        // Proceed with 0 counts for bars
                    } else if (completionsData) {
                        videosToday = completionsData.filter(i => i.item_type === 'video').length;
                        quizzesToday = completionsData.filter(i => i.item_type === 'quiz').length;
                    }
                    console.log(`DEBUG (QuotaDisplay): Display using completions: ${videosToday} videos, ${quizzesToday} quizzes.`);
                } catch (fetchError) {
                    console.error('DEBUG (QuotaDisplay): Exception fetching completions for display:', fetchError);
                    // Proceed with 0 counts
                }


                // --- 3. Check Supabase Quota Met Status (Best Effort Read) ---
                let isQuotaMetInDB = false;
                const todayDateString = startOfDayUTC.toISOString().split('T')[0];
                let dbReadSucceeded = false;

                try {
                    const { data: quotaStatusData, error: quotaStatusError } = await supabaseClient
                        .from('daily_quotas_met')
                        .select('id') // Use standard GET
                        .eq('user_id', currentUserId)
                        .eq('quota_date', todayDateString)
                        .maybeSingle();

                    if (quotaStatusError) {
                       console.warn(`DEBUG (QuotaDisplay): Error fetching quota status from DB for display: ${quotaStatusError.message}`);
                       // dbReadSucceeded remains false
                    } else {
                       isQuotaMetInDB = (quotaStatusData !== null);
                       dbReadSucceeded = true; // Read was successful
                    }
                     console.log(`DEBUG (QuotaDisplay): Quota met status from DB read: ${isQuotaMetInDB} (Read success: ${dbReadSucceeded})`);

                 } catch (statusError) {
                    console.error('DEBUG (QuotaDisplay): Exception fetching quota met status for display:', statusError);
                     // dbReadSucceeded remains false
                 }

                // --- 4. Determine FINAL Display Status (NEW LOGIC) ---
                // Trust the body class set by _performQuotaCheck if the DB read failed or seems inconsistent
                const isBodyClassSet = document.body.classList.contains('quota-met-today');
                let displayQuotaMet;

                if (dbReadSucceeded) {
                    // If DB read worked, trust it *unless* it contradicts the body class set by the write function
                    if (isQuotaMetInDB && !isBodyClassSet) {
                        console.warn("DEBUG (QuotaDisplay): DB says MET, but body class NOT set. Using DB status (Met).");
                        displayQuotaMet = true;
                    } else if (!isQuotaMetInDB && isBodyClassSet) {
                        console.warn("DEBUG (QuotaDisplay): DB says NOT MET, but body class IS set. Using body class status (Met).");
                        displayQuotaMet = true; // Trust the write/conflict outcome
                    } else {
                        // DB read and body class are consistent (or DB read succeeded and body class matches)
                        displayQuotaMet = isQuotaMetInDB;
                    }
                } else {
                    // DB read failed, rely solely on the body class set by _performQuotaCheck
                    console.warn("DEBUG (QuotaDisplay): DB read failed or inconsistent, relying on body class.");
                    displayQuotaMet = isBodyClassSet;
                }
                 console.log(`DEBUG (QuotaDisplay): Final determined display status: ${displayQuotaMet}`);


                // --- 5. Build HTML ---
                let statusHtml = `<h3 class="text-lg font-semibold mb-3 text-indigo-800">Today's Dynamic Goal Progress</h3>`;

                // Video Progress Bar (same as before)
                const videoPercent = requiredVideosPerDay > 0 ? Math.min(100, (videosToday / requiredVideosPerDay) * 100) : (videosToday > 0 ? 100 : 0);
                statusHtml += `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Videos</span>
                            <span class="text-sm font-medium text-gray-700">${videosToday}/${requiredVideosPerDay}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${videoPercent}%"></div>
                        </div>
                    </div>`;

                // Quiz Progress Bar (same as before)
                const quizPercent = requiredQuizzesPerDay > 0 ? Math.min(100, (quizzesToday / requiredQuizzesPerDay) * 100) : (quizzesToday > 0 ? 100 : 0);
                statusHtml += `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Quizzes</span>
                            <span class="text-sm font-medium text-gray-700">${quizzesToday}/${requiredQuizzesPerDay}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: ${quizPercent}%"></div>
                        </div>
                    </div>`;

                // Overall Status Message (using the final 'displayQuotaMet' determination)
                if (displayQuotaMet) { // Use the final determined status
                    statusHtml += `
                        <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg mb-3">
                            <svg class="w-6 h-6 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <p class="font-medium text-green-700">Met! Well done!</p>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">
                           Your dynamic quota completion for today has been recorded.
                        </p>`;
                } else {
                    statusHtml += `
                        <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-3">
                            <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <p class="font-medium text-yellow-700">Not yet met. Keep going!</p>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">
                            Complete approximately ${requiredVideosPerDay} videos and ${requiredQuizzesPerDay} quizzes today to meet your dynamic goal.
                        </p>`;
                }

                container.innerHTML = statusHtml;

            } catch (error) {
                console.error('Critical Error in displayDailyQuotaStatus:', error);
                 container.innerHTML = `
                     <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                         <p class="text-red-700">Could not display quota status due to an error: ${error.message}</p>
                     </div>
                 `;
            }
        }
        
        // Function to fetch and display peer quota achievements
               // Function to fetch and display peer quota achievements
               async function fetchAndDisplayPeerQuotas() {
            const tableContainer = document.getElementById('peer-quota-table-container');
            const loadingEl = document.getElementById('peer-quota-loading');
            const tableEl = document.getElementById('peer-quota-table');

            // Show loading and clear table
            loadingEl.style.display = 'block';
            tableEl.innerHTML = '';

            try {
                // Fetch usernames
                const { data: usersData, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id, username')
                    .order('username');

                if (usersError) {
                    throw new Error(`Error fetching users: ${usersError.message}`);
                }

                if (!usersData || usersData.length === 0) {
                    tableEl.innerHTML = `<p class="text-gray-500">No users found in the system.</p>`;
                    loadingEl.style.display = 'none'; // Hide loading if no users
                    return;
                }

                // Fetch quota counts using the RPC function
                // --- CORRECTION HERE ---
                const { data: quotaCountsData, error: rpcError } = await supabaseClient
                    .rpc('get_user_quota_counts');
                // --- END CORRECTION ---

                if (rpcError) {
                    // Log the specific RPC error for debugging
                    console.error("Supabase RPC error fetching quota counts:", rpcError);
                    throw new Error(`Error fetching quota counts via RPC: ${rpcError.message}`);
                }

                // Process data from RPC
                const userQuotaCounts = {};

                // The RPC returns data in the format specified by RETURNS TABLE:
                // [{ user_id: 1, quota_count: 5 }, { user_id: 2, quota_count: 10 }]
                if (quotaCountsData && quotaCountsData.length > 0) {
                    quotaCountsData.forEach(item => {
                        // Access the count using the column name defined in the SQL function ('quota_count')
                        userQuotaCounts[item.user_id] = item.quota_count;
                    });
                }

                // Create data array for the table
                const userDataForTable = [];

                usersData.forEach(user => {
                    const count = userQuotaCounts[user.id] || 0; // Default to 0 if no count found
                    userDataForTable.push({
                        username: user.username,
                        count: count,
                        userId: user.id // Keep userId if needed for highlighting
                    });
                });

                // Sort by count (descending)
                userDataForTable.sort((a, b) => b.count - a.count);

                // Clear loading message
                loadingEl.style.display = 'none';

                // Create table HTML (Same as before)
                let tableHtml = `
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Quotas Met</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                `;

                // Add rows for each user (Same as before)
                userDataForTable.forEach((userData, index) => {
                    const isCurrentUser = userData.userId === currentUserId;
                    const rowClass = isCurrentUser ? 'bg-blue-50' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white');
                    const textClass = isCurrentUser ? 'font-medium text-blue-800' : '';

                    let starDisplay;
                    if (userData.count <= 20) {
                        starDisplay = 'â­'.repeat(userData.count) || '<span class="text-gray-400">0</span>';
                    } else {
                        starDisplay = `â­ Ã— ${userData.count}`;
                    }

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td class="py-2 px-4 text-sm ${textClass}">${userData.username}${isCurrentUser ? ' (you)' : ''}</td>
                            <td class="py-2 px-4 text-sm ${textClass}">${starDisplay}</td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                    <p class="mt-2 text-xs text-gray-500">Last updated: ${new Date().toLocaleString()}</p>
                `;

                tableEl.innerHTML = tableHtml;

            } catch (err) {
                console.error("Error in fetchAndDisplayPeerQuotas:", err); // Log the caught error
                tableEl.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-700">Error fetching peer quota data: ${err.message || 'Unknown error'}</p>
                    </div>
                `;
            } finally {
                // Hide loading message regardless of success or failure
                loadingEl.style.display = 'none';
            }
        }
        
        // Handle document visibility change to check/update bookmark in real-time
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                if (currentUserId) {
                    displayGlobalBookmarkIndicator();
                }
            }
        });
        
        // Define unit ID for this page
    </script>
    
    <!-- React Component -->
    <script type="text/babel">
        const APStatLearningFlow = () => {
          const [currentStep, setCurrentStep] = React.useState(0);
          
          const steps = [
            {
              title: "1. Set Up",
              icon: "ðŸ“",
              content: "Gather all your materials before starting your AP Statistics learning session",
              tips: ["Find a quiet place to focus", "Make sure your laptop is charged", "Have your calculator and formula sheet ready"],
              color: "blue" // Setup color
            },
            {
              title: "2. Prepare Grok",
              icon: "ðŸ¤–",
              content: "Open Grok, set up the AI tutor, and download the corresponding PDFs from Study Materials",
              tips: ["Copy the provided AP Statistics tutor prompt", "Attach both question and answer PDFs to your Grok conversation"],
              color: "blue" // Setup color
            },
            {
              title: "3. Watch Video",
              icon: "ðŸ“º",
              content: "Actively watch the video lesson for your current topic",
              tips: ["Take notes on paper", "Work through every example shown", "Videos are linked in the Study Materials tab", "Look for (+) icon for videos with backups", "Hover over the (+) icon if AP Classroom is down"],
              color: "yellow" // Video learning color
            },
            {
              title: "4. Ask Questions",
              icon: "â“",
              content: "If you get confused during the video, pause and ask Grok for help",
              tips: ["Be specific about what confused you", "Return to the video once you understand"],
              color: "yellow" // Video learning color
            },
            {
              title: "5. Practice Problems",
              icon: "ðŸ§©",
              content: "After the video, use Grok to work through the practice problems",
              tips: ["Grok will guide you through all questions", "Use the answer PDF to verify your work"],
              color: "green" // Practice color
            },
            {
              title: "6. Track Progress",
              icon: "âœ…",
              content: "Mark the topic as completed once you've mastered it",
              tips: ["The next topic will automatically become your focus", "Complete all topics before attempting the capstone challenge"],
              color: "purple" // Progress color
            }
          ];
          
          const handlePrev = () => {
            setCurrentStep(prev => Math.max(0, prev - 1));
          };
          
          const handleNext = () => {
            setCurrentStep(prev => Math.min(steps.length - 1, prev + 1));
          };
          
          // Get color classes based on step color
          const getColorClasses = (stepColor) => {
            switch(stepColor) {
              case 'blue':
                return { bg: 'bg-blue-100', text: 'text-blue-800', active: 'text-blue-600', button: 'bg-blue-500 hover:bg-blue-600' };
              case 'yellow':
                return { bg: 'bg-yellow-100', text: 'text-yellow-800', active: 'text-yellow-600', button: 'bg-yellow-500 hover:bg-yellow-600' };
              case 'green':
                return { bg: 'bg-green-100', text: 'text-green-800', active: 'text-green-600', button: 'bg-green-500 hover:bg-green-600' };
              case 'purple':
                return { bg: 'bg-purple-100', text: 'text-purple-800', active: 'text-purple-600', button: 'bg-purple-500 hover:bg-purple-600' };
              case 'red':
                return { bg: 'bg-red-100', text: 'text-red-800', active: 'text-red-600', button: 'bg-red-500 hover:bg-red-600' };
              default:
                return { bg: 'bg-gray-100', text: 'text-gray-800', active: 'text-gray-600', button: 'bg-gray-500 hover:bg-gray-600' };
            }
          };

          return (
            <div className="flex flex-col bg-gray-50 p-4 rounded-lg max-w-4xl mx-auto">
              <h1 className="text-2xl font-bold text-center mb-6">AP Statistics: Using Grok to Help You Learn</h1>
              
              {/* Progress Tracker */}
              <div className="flex flex-wrap justify-between mb-8">
                {steps.map((step, idx) => {
                  const colorClasses = getColorClasses(step.color);
                  return (
                    <div 
                      key={idx} 
                      className={`flex flex-col items-center cursor-pointer mb-2 ${idx <= currentStep ? colorClasses.active : 'text-gray-400'}`}
                      onClick={() => setCurrentStep(idx)}
                    >
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl mb-2 ${idx <= currentStep ? colorClasses.bg : 'bg-gray-200'}`}>
                        {step.icon}
                      </div>
                      <div className="text-xs font-medium text-center w-20">{step.title}</div>
                    </div>
                  );
                })}
              </div>
              
              {/* Step Content */}
              <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 className="text-xl font-bold mb-4">{steps[currentStep].title}</h2>
                <p className="mb-4">{steps[currentStep].content}</p>
                
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="font-bold text-blue-800 mb-2">Pro Tips:</h3>
                  <ul className="list-disc pl-5">
                    {steps[currentStep].tips.map((tip, idx) => (
                      <li key={idx} className="mb-1">{tip}</li>
                    ))}
                  </ul>
                </div>
              </div>
              
              {/* Materials List (visible on all screens) */}
              <div className="bg-white p-4 rounded-lg shadow-md mb-6">
                <h3 className="font-bold mb-2">Materials Needed:</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <div className="flex items-center"><span className="mr-2">ðŸ“„</span> Paper</div>
                  <div className="flex items-center"><span className="mr-2">âœï¸</span> Pencil</div>
                  <div className="flex items-center"><span className="mr-2">ðŸ§®</span> Calculator</div>
                  <div className="flex items-center"><span className="mr-2">ðŸ’»</span> Laptop</div>
                  <div className="flex items-center"><span className="mr-2">ðŸŽ§</span> Headphones (optional)</div>
                  <div className="flex items-center"><span className="mr-2">ðŸ“‹</span> Clipboard</div>
                  <div className="flex items-center"><span className="mr-2">ðŸ“‘</span> AP Exam Formula Sheet</div>
                </div>
              </div>
              
              {/* Navigation Buttons */}
              <div className="flex justify-between">
                <button 
                  onClick={handlePrev} 
                  className={`px-4 py-2 rounded-lg ${currentStep === 0 ? 'bg-gray-200 text-gray-500' : 'bg-blue-500 text-white'}`}
                  disabled={currentStep === 0}
                >
                  Previous Step
                </button>
                <button 
                  onClick={handleNext} 
                  className={`px-4 py-2 rounded-lg ${currentStep === steps.length - 1 ? 'bg-gray-200 text-gray-500' : 'bg-blue-500 text-white'}`}
                  disabled={currentStep === steps.length - 1}
                >
                  Next Step
                </button>
              </div>
            </div>
          );
        };

        // Render React component
        ReactDOM.render(<APStatLearningFlow />, document.getElementById('learning-flow-app'));
        
        // Listen for browser coming back online
        window.addEventListener('online', function() {
            console.log("Browser detected online status.");
            
            if (currentUserId) {
                syncOfflineQueue();
            } else {
                console.log("User not identified, cannot sync yet.");
            }
        });
    </script>
    
    <!-- QR Code Section -->
    <div class="my-4 flex flex-col items-center">
        <div id="qrcode-container" class="p-2 bg-white border border-gray-300 rounded-lg shadow-sm inline-block">
            <!-- QR code will be rendered here -->
        </div>
        <p class="text-xs text-gray-500 mt-1">Scan for page link</p>
        <a href="https://github.com/robjohncolson/ApstatUnit1.git" target="_blank" class="flex items-center text-gray-600 hover:text-blue-600 text-xs mt-2">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z"></path>
            </svg>
            View on GitHub
        </a>
    </div>
    <!-- End QR Code Section -->

    
</body>
</html> 